<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Workout Tracker</title>

  <!-- PWA / iPhone meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Gym Tracker">
  <meta name="theme-color" content="#0a0a0f">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Icon for Add to Home Screen -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230a0a0f'/><text y='72' x='50' text-anchor='middle' font-size='60'>ğŸ‹ï¸</text></svg>">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: #0a0a0f; overflow-x: hidden; }
    html { overflow-x: hidden; }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
  </style>

  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Recharts peer dep -->
  <script crossorigin src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>

  <!-- Recharts -->
  <script crossorigin src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

  <!-- Babel for JSX transpilation -->
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;
const { ResponsiveContainer, ComposedChart, Line, XAxis, YAxis, Tooltip, CartesianGrid, Legend } = Recharts;


// type: "s" = standard (kg+reps), "b" = bodyweight (reps only), "t" = timed (seconds), "c" = class/series (minutes+bpm)
const DEFAULT_EXERCISES = {
  Pecho: [
    { id: "bench_press", name: "Press Banca", emoji: "ğŸ‹ï¸", type: "s" },
    { id: "bench_press_db", name: "Press Banca Mancuernas", emoji: "ğŸ‹ï¸", type: "s" },
    { id: "incline_bench", name: "Press Inclinado Barra", emoji: "ğŸ‹ï¸", type: "s" },
    { id: "incline_bench_db", name: "Press Inclinado Mancuernas", emoji: "ğŸ‹ï¸", type: "s" },
    { id: "decline_bench", name: "Press Declinado", emoji: "ğŸ‹ï¸", type: "s" },
    { id: "dumbbell_fly", name: "Aperturas Mancuernas", emoji: "ğŸ’ª", type: "s" },
    { id: "cable_crossover", name: "Cruce de Poleas", emoji: "ğŸ”„", type: "s" },
    { id: "chest_dip", name: "Fondos en Paralelas", emoji: "â¬‡ï¸", type: "b" },
    { id: "pushup", name: "Flexiones", emoji: "ğŸ«³", type: "b" },
    { id: "pike_pushup", name: "Flexiones en Pica", emoji: "ğŸ«³", type: "b" },
    { id: "diamond_pushup", name: "Flexiones Diamante", emoji: "ğŸ’", type: "b" },
    { id: "chest_press_machine", name: "Press en MÃ¡quina", emoji: "ğŸ‹ï¸", type: "s" },
    { id: "pec_deck", name: "Pec Deck / Contractora", emoji: "ğŸ”„", type: "s" },
  ],
  Espalda: [
    { id: "pullup_pronate", name: "Dominadas Pronadas", emoji: "ğŸ”", type: "b" },
    { id: "pullup_supinate", name: "Dominadas Supinas", emoji: "ğŸ”", type: "b" },
    { id: "pullup_neutral", name: "Dominadas Neutras", emoji: "ğŸ”", type: "b" },
    { id: "weighted_pullup", name: "Dominadas Lastradas", emoji: "ğŸ”", type: "s" },
    { id: "barbell_row", name: "Remo con Barra", emoji: "ğŸš£", type: "s" },
    { id: "dumbbell_row", name: "Remo con Mancuerna", emoji: "ğŸš£", type: "s" },
    { id: "trx_row", name: "Remo en TRX", emoji: "ğŸš£", type: "b" },
    { id: "lat_pulldown", name: "JalÃ³n al Pecho", emoji: "â¬‡ï¸", type: "s" },
    { id: "lat_pulldown_close", name: "JalÃ³n Agarre Cerrado", emoji: "â¬‡ï¸", type: "s" },
    { id: "cable_row", name: "Remo en Polea", emoji: "ğŸ”„", type: "s" },
    { id: "t_bar_row", name: "Remo en T", emoji: "ğŸš£", type: "s" },
    { id: "deadlift", name: "Peso Muerto", emoji: "ğŸ‹ï¸", type: "s" },
    { id: "face_pull", name: "Face Pull", emoji: "ğŸ¯", type: "s" },
    { id: "pullover", name: "Pullover", emoji: "ğŸ’ª", type: "s" },
    { id: "seal_row", name: "Remo en Banco (Seal Row)", emoji: "ğŸš£", type: "s" },
  ],
  Pierna: [
    { id: "squat", name: "Sentadilla con Barra", emoji: "ğŸ¦µ", type: "s" },
    { id: "front_squat", name: "Sentadilla Frontal", emoji: "ğŸ¦µ", type: "s" },
    { id: "goblet_squat", name: "Sentadilla Goblet", emoji: "ğŸ¦µ", type: "s" },
    { id: "leg_press", name: "Prensa", emoji: "ğŸ¦¿", type: "s" },
    { id: "hack_squat", name: "Hack Squat", emoji: "ğŸ¦¿", type: "s" },
    { id: "romanian_deadlift", name: "Peso Muerto Rumano", emoji: "ğŸ‹ï¸", type: "s" },
    { id: "rdl_single_leg", name: "Peso Muerto Rumano a 1 Pierna", emoji: "ğŸ‹ï¸", type: "s" },
    { id: "leg_curl_lying", name: "Curl Femoral Tumbado", emoji: "ğŸ¦µ", type: "s" },
    { id: "leg_curl_seated", name: "Curl Femoral Sentado", emoji: "ğŸ¦µ", type: "s" },
    { id: "nordic_curl", name: "Nordic Curl", emoji: "ğŸ¦µ", type: "b" },
    { id: "leg_extension", name: "ExtensiÃ³n de CuÃ¡driceps", emoji: "ğŸ¦¿", type: "s" },
    { id: "calf_raise_standing", name: "Gemelo de Pie", emoji: "ğŸ¦¶", type: "s" },
    { id: "calf_raise_seated", name: "Gemelo Sentado", emoji: "ğŸ¦¶", type: "s" },
    { id: "hip_thrust", name: "Hip Thrust", emoji: "ğŸ‘", type: "s" },
    { id: "glute_bridge", name: "Glute Bridge", emoji: "ğŸ‘", type: "b" },
    { id: "bulgarian_split", name: "Sentadilla BÃºlgara", emoji: "ğŸ¦µ", type: "s" },
    { id: "lunges", name: "Zancadas", emoji: "ğŸ¦µ", type: "s" },
    { id: "step_up", name: "Step Up", emoji: "ğŸ¦µ", type: "s" },
    { id: "adductor_machine", name: "Aductores en MÃ¡quina", emoji: "ğŸ¦¿", type: "s" },
    { id: "abductor_machine", name: "Abductores en MÃ¡quina", emoji: "ğŸ¦¿", type: "s" },
  ],
  Hombro: [
    { id: "ohp", name: "Press Militar con Barra", emoji: "â¬†ï¸", type: "s" },
    { id: "ohp_db", name: "Press Militar Mancuernas", emoji: "â¬†ï¸", type: "s" },
    { id: "arnold_press", name: "Press Arnold", emoji: "ğŸ’ª", type: "s" },
    { id: "lateral_raise_db", name: "Elevaciones Laterales Mancuerna", emoji: "ğŸ¦…", type: "s" },
    { id: "lateral_raise_cable", name: "Elevaciones Laterales Polea", emoji: "ğŸ¦…", type: "s" },
    { id: "front_raise", name: "Elevaciones Frontales", emoji: "ğŸ™Œ", type: "s" },
    { id: "rear_delt_fly", name: "PÃ¡jaro / Rear Delt Fly", emoji: "ğŸ¦…", type: "s" },
    { id: "rear_delt_machine", name: "Rear Delt en MÃ¡quina", emoji: "ğŸ¦…", type: "s" },
    { id: "upright_row", name: "Remo al MentÃ³n", emoji: "â¬†ï¸", type: "s" },
    { id: "shrug", name: "Encogimientos (Shrugs)", emoji: "ğŸ¤·", type: "s" },
    { id: "landmine_press", name: "Landmine Press", emoji: "â¬†ï¸", type: "s" },
    { id: "shoulder_press_machine", name: "Press de Hombro en MÃ¡quina", emoji: "ğŸ‹ï¸", type: "s" },
  ],
  BÃ­ceps: [
    { id: "barbell_curl", name: "Curl con Barra", emoji: "ğŸ’ª", type: "s" },
    { id: "ez_curl", name: "Curl con Barra EZ", emoji: "ğŸ’ª", type: "s" },
    { id: "dumbbell_curl", name: "Curl Mancuernas", emoji: "ğŸ’ª", type: "s" },
    { id: "hammer_curl", name: "Curl Martillo", emoji: "ğŸ”¨", type: "s" },
    { id: "preacher_curl", name: "Curl en Banco Scott", emoji: "ğŸ“–", type: "s" },
    { id: "incline_curl", name: "Curl Inclinado", emoji: "ğŸ’ª", type: "s" },
    { id: "concentration_curl", name: "Curl Concentrado", emoji: "ğŸ’ª", type: "s" },
    { id: "cable_curl", name: "Curl en Polea", emoji: "ğŸ”„", type: "s" },
    { id: "spider_curl", name: "Spider Curl", emoji: "ğŸ•·ï¸", type: "s" },
  ],
  TrÃ­ceps: [
    { id: "tricep_pushdown_rope", name: "ExtensiÃ³n Polea (Cuerda)", emoji: "â¬‡ï¸", type: "s" },
    { id: "tricep_pushdown_bar", name: "ExtensiÃ³n Polea (Barra)", emoji: "â¬‡ï¸", type: "s" },
    { id: "overhead_ext_db", name: "ExtensiÃ³n Overhead Mancuerna", emoji: "â¬†ï¸", type: "s" },
    { id: "overhead_ext_cable", name: "ExtensiÃ³n Overhead Polea", emoji: "â¬†ï¸", type: "s" },
    { id: "skullcrusher", name: "Press FrancÃ©s", emoji: "ğŸ’€", type: "s" },
    { id: "close_grip_bench", name: "Press Agarre Cerrado", emoji: "ğŸ‹ï¸", type: "s" },
    { id: "tricep_dip", name: "Fondos TrÃ­ceps", emoji: "â¬‡ï¸", type: "b" },
    { id: "kickback", name: "Kickback", emoji: "ğŸ’ª", type: "s" },
  ],
  Core: [
    { id: "plank", name: "Plancha", emoji: "ğŸ§˜", type: "t" },
    { id: "side_plank", name: "Plancha Lateral", emoji: "ğŸ§˜", type: "t" },
    { id: "crunch", name: "Crunch", emoji: "ğŸ”„", type: "b" },
    { id: "leg_raise_hanging", name: "ElevaciÃ³n Piernas Colgado", emoji: "ğŸ¦µ", type: "b" },
    { id: "leg_raise_lying", name: "ElevaciÃ³n Piernas Tumbado", emoji: "ğŸ¦µ", type: "b" },
    { id: "cable_crunch", name: "Crunch en Polea", emoji: "ğŸ”„", type: "s" },
    { id: "ab_wheel", name: "Rueda Abdominal", emoji: "ğŸ›", type: "b" },
    { id: "russian_twist", name: "Giros Rusos", emoji: "ğŸ”„", type: "b" },
    { id: "pallof_press", name: "Pallof Press", emoji: "ğŸ¯", type: "s" },
    { id: "dead_bug", name: "Dead Bug", emoji: "ğŸª²", type: "b" },
    { id: "woodchop", name: "LeÃ±ador (Wood Chop)", emoji: "ğŸª“", type: "s" },
  ],
  Cardio: [
    { id: "outdoor_run", name: "Correr Aire Libre", emoji: "ğŸŒ³", type: "t" },
    { id: "treadmill", name: "Cinta de Correr", emoji: "ğŸƒ", type: "t" },
    { id: "bike", name: "Bicicleta EstÃ¡tica", emoji: "ğŸš´", type: "t" },
    { id: "rowing", name: "Remo ErgÃ³metro", emoji: "ğŸš£", type: "t" },
    { id: "elliptical", name: "ElÃ­ptica", emoji: "ğŸƒ", type: "t" },
    { id: "stairmaster", name: "Stairmaster", emoji: "ğŸªœ", type: "t" },
    { id: "jump_rope", name: "Comba", emoji: "â­ï¸", type: "t" },
  ],
  "Cross Training": [
    { id: "ct_kb_swing", name: "Kettlebell Swing", emoji: "ğŸ””", type: "s" },
    { id: "ct_thruster", name: "Thrusters", emoji: "ğŸ‹ï¸", type: "s" },
    { id: "ct_mountain_climber", name: "Escaladores", emoji: "ğŸ§—", type: "b" },
    { id: "ct_reverse_lunge", name: "Zancadas AtrÃ¡s", emoji: "ğŸ¦µ", type: "b" },
    { id: "ct_pushup", name: "Flexiones", emoji: "ğŸ«³", type: "b" },
    { id: "ct_burpee", name: "Burpees", emoji: "ğŸ’¥", type: "b" },
    { id: "ct_plank", name: "Plancha Abdominal", emoji: "ğŸ§˜", type: "t" },
    { id: "ct_box_jump", name: "Box Jump", emoji: "ğŸ“¦", type: "b" },
    { id: "ct_wall_ball", name: "Wall Ball", emoji: "ğŸ", type: "s" },
    { id: "ct_battle_rope", name: "Battle Rope", emoji: "ğŸª¢", type: "t" },
    { id: "ct_goblet_squat", name: "Goblet Squat", emoji: "ğŸ¦µ", type: "s" },
    { id: "ct_jumping_jack", name: "Jumping Jacks", emoji: "â­", type: "b" },
    { id: "ct_devil_press", name: "Devil Press", emoji: "ğŸ˜ˆ", type: "s" },
  ],
  Series: [
    { id: "series_cross", name: "Cross Training", emoji: "ğŸ”¥", type: "c" },
    { id: "series_hyrox", name: "Hybrid", emoji: "ğŸ…", type: "c" },
    { id: "series_hiit", name: "HIIT", emoji: "âš¡", type: "c" },
  ],
};

const CUSTOM_EXERCISES_KEY = "gym-tracker-custom-exercises";
const CUSTOM_FOODS_KEY = "gym-tracker-custom-foods";
const STORAGE_KEY = "gym-tracker-data";
const NUTRITION_KEY = "gym-tracker-nutrition";
const WEIGHT_KEY = "gym-tracker-weight";
const NUTRITION_SETTINGS_KEY = "gym-tracker-nutrition-settings";
const ACTIVE_WORKOUT_KEY = "gym-tracker-active-workout";
const PLANS_KEY = "gym-tracker-plans";
const CHAT_KEY = "gym-tracker-chat";
const GEMINI_KEY = "gym-tracker-gemini-key";
const COACH_CONTEXT_KEY = "gym-tracker-coach-context";
const COACH_LENGTH_KEY = "gym-tracker-coach-length";

// â”€â”€ FOOD DATABASE (per 100g) â”€â”€
const FOOD_DB = [
  { id: "atun_natural", name: "AtÃºn Natural", group: "Base", cal: 112, prot: 27 },
  { id: "clara", name: "Clara de huevo", group: "Base", cal: 48, prot: 10.9 },
  { id: "pechuga_pavo", name: "Pechuga de pavo", group: "Base", cal: 112, prot: 25.1 },
  { id: "pechuga_pollo", name: "Pechuga pollo", group: "Base", cal: 107, prot: 23.7 },
  { id: "filete_ternera", name: "Filete ternera", group: "Base", cal: 125, prot: 21.5 },
  { id: "salmon_ahumado", name: "SalmÃ³n Ahumado", group: "Base", cal: 226, prot: 24 },
  { id: "salmon_froya", name: "SalmÃ³n Froya", group: "Base", cal: 226, prot: 19.7 },
  { id: "atun_aceite", name: "AtÃºn Aceite de Oliva", group: "Base", cal: 238, prot: 24 },
  { id: "jamon_iberico", name: "JamÃ³n IbÃ©rico", group: "Base", cal: 355, prot: 26.9 },
  { id: "albondigas", name: "AlbÃ³ndigas", group: "Base", cal: 150, prot: 12 },
  { id: "pollo_empanado", name: "Pollo empanado", group: "Base", cal: 250, prot: 20 },
  { id: "ensalada_pasta", name: "Ensalada pasta", group: "Base", cal: 195, prot: 10 },
  { id: "tortilla_patatas", name: "Tortilla patatas", group: "Base", cal: 180, prot: 6 },
  { id: "pavo_cocido", name: "Pavo Cocido (Merc)", group: "Picar", cal: 78, prot: 17.8 },
  { id: "pavo_braseado", name: "Pavo braseado (Camp)", group: "Picar", cal: 86, prot: 17 },
  { id: "jamon_serrano", name: "JamÃ³n Serrano (Merc)", group: "Picar", cal: 248, prot: 33.5 },
  { id: "postre_lacteo_dia", name: "Postre LÃ¡cteo (DIA)", group: "LÃ¡cteos", cal: 53, prot: 10 },
  { id: "queso_fresco_batido", name: "Queso fresco batido GR", group: "LÃ¡cteos", cal: 47, prot: 8.5 },
  { id: "queso_fresco_yogur", name: "Queso fresco batido yogur", group: "LÃ¡cteos", cal: 60, prot: 8 },
  { id: "yogur_desnatado", name: "Yogur desnatado", group: "LÃ¡cteos", cal: 46, prot: 5.4 },
  { id: "mouse_cacao", name: "Mousse Cacao (DIA)", group: "LÃ¡cteos", cal: 74, prot: 10 },
  { id: "yopro", name: "YoPro", group: "LÃ¡cteos", cal: 58, prot: 10 },
  { id: "protein_plus", name: "Protein+", group: "LÃ¡cteos", cal: 46, prot: 8 },
  { id: "protein_straccia", name: "Protein+ Stracciatella", group: "LÃ¡cteos", cal: 47, prot: 7.6 },
  { id: "griego_ligero", name: "Griego Ligero (Merc)", group: "LÃ¡cteos", cal: 60, prot: 5.8 },
  { id: "natillas_choco", name: "Natillas Chocolate (Merc)", group: "LÃ¡cteos", cal: 81, prot: 8.4 },
  { id: "postre_lacteo_merc", name: "Postre LÃ¡cteo (Merc)", group: "LÃ¡cteos", cal: 52, prot: 10 },
  { id: "fage", name: "FAGE 0%", group: "LÃ¡cteos", cal: 54, prot: 10.3 },
  { id: "leche_desnatada", name: "Leche Desnatada", group: "LÃ¡cteos", cal: 34, prot: 3.2 },
  { id: "leche_semi", name: "Leche Semidesnatada", group: "LÃ¡cteos", cal: 46, prot: 3.1 },
  { id: "cottage_proteina", name: "Queso Cottage ProteÃ­na", group: "Quesos", cal: 80, prot: 15 },
  { id: "queso_lonchas_arla", name: "Queso Lonchas Arla", group: "Quesos", cal: 186, prot: 34 },
  { id: "requeson", name: "RequesÃ³n", group: "Quesos", cal: 72, prot: 12.2 },
  { id: "cottage_arla", name: "Queso Cottage Arla", group: "Quesos", cal: 97, prot: 13 },
  { id: "queso_protein_plus", name: "Queso Protein+", group: "Quesos", cal: 215, prot: 34 },
  { id: "queso", name: "Queso", group: "Quesos", cal: 400, prot: 25 },
  { id: "palmito", name: "Palmito", group: "Verdura", cal: 27, prot: 2.4 },
  { id: "edamame", name: "Edamame", group: "Verdura", cal: 124, prot: 11 },
  { id: "ensalada", name: "Ensalada variada", group: "Verdura", cal: 18, prot: 0.8 },
  { id: "brocoli", name: "BrÃ³coli", group: "Verdura", cal: 35, prot: 2 },
  { id: "gazpacho", name: "Gazpacho", group: "Verdura", cal: 45, prot: 0.8 },
  { id: "esparragos", name: "EspÃ¡rragos", group: "Verdura", cal: 19, prot: 1.3 },
  { id: "allbran", name: "All Bran", group: "Hidratos", cal: 335, prot: 14 },
  { id: "pan", name: "Pan Artesano", group: "Hidratos", cal: 243, prot: 10 },
  { id: "avena", name: "Avena", group: "Hidratos", cal: 372, prot: 10 },
  { id: "arroz", name: "Arroz", group: "Hidratos", cal: 164, prot: 4 },
  { id: "arroz_integral", name: "Arroz integral", group: "Hidratos", cal: 168, prot: 4 },
  { id: "patata_asada", name: "Patata Asada", group: "Hidratos", cal: 70, prot: 2 },
  { id: "mix_mercadona", name: "Mix Mercadona", group: "Hidratos", cal: 372, prot: 9.4 },
  { id: "platano", name: "PlÃ¡tano", group: "Fruta", cal: 92, prot: 1.1 },
  { id: "picotas", name: "Picotas", group: "Fruta", cal: 41, prot: 0.75 },
  { id: "melon", name: "MelÃ³n", group: "Fruta", cal: 31, prot: 0.7 },
  { id: "melocoton", name: "MelocotÃ³n", group: "Fruta", cal: 40, prot: 0.7 },
  { id: "chocolate_70", name: "Chocolate 70%", group: "Otros", cal: 481, prot: 11 },
  { id: "tomate_frito", name: "Tomate Frito", group: "Otros", cal: 94, prot: 1.2 },
  { id: "yema_huevo", name: "Yema de huevo", group: "Grasas", cal: 322, prot: 15.86 },
  { id: "anacardos_nueces", name: "Anacardos/Nueces", group: "Grasas", cal: 600, prot: 18 },
  { id: "aguacate", name: "Aguacate", group: "Grasas", cal: 160, prot: 2 },
  { id: "aove", name: "AOVE", group: "Grasas", cal: 900, prot: 0 },
  { id: "cerveza", name: "Cerveza", group: "Alcohol", cal: 49, prot: 0.4 },
  { id: "vino", name: "Vino", group: "Alcohol", cal: 80, prot: 0.2 },
];
const FOOD_GROUPS = [...new Set(FOOD_DB.map((f) => f.group))];

const TYPE_LABELS = { s: "Peso + Reps", b: "Solo Reps", t: "Tiempo" };
const TYPE_TAGS = { s: "kg+reps", b: "bodyweight", t: "tiempo", c: "min+bpm" };

const formatDate = (d) => {
  const date = new Date(d);
  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  if (date.toDateString() === today.toDateString()) return "Hoy";
  if (date.toDateString() === yesterday.toDateString()) return "Ayer";
  return date.toLocaleDateString("es-ES", { day: "numeric", month: "short" });
};

const formatFullDate = (d) =>
  new Date(d).toLocaleDateString("es-ES", { weekday: "long", day: "numeric", month: "long" });

const fmtSec = (s) => {
  const n = Number(s);
  if (n >= 60) return `${Math.floor(n / 60)}m${n % 60 ? `${n % 60}s` : ""}`;
  return `${n}s`;
};

const emptySet = (type) => {
  if (type === "t") return { seconds: "", distance: "", heartRate: "", done: false };
  if (type === "c") return { minutes: "", heartRate: "", done: false };
  if (type === "b") return { reps: "", done: false };
  return { weight: "", reps: "", done: false };
};

const isSetValid = (set, type) => {
  if (type === "t") return set.done && set.seconds;
  if (type === "c") return set.done && set.minutes;
  if (type === "b") return set.done && set.reps;
  return set.done && set.weight && set.reps;
};

const formatSetShort = (set, type) => {
  if (type === "t") { let r = fmtSec(set.seconds); if (set.distance) r += ` Â· ${set.distance}km`; return r; }
  if (type === "c") { let r = `${set.minutes} min`; if (set.heartRate) r += ` Â· ${set.heartRate} bpm`; return r; }
  if (type === "b") return `${set.reps} reps`;
  return `${set.weight}Ã—${set.reps}`;
};

const formatSetDetail = (set, type) => {
  if (type === "t") return <>{fmtSec(set.seconds)}{set.distance ? <span style={{ opacity: 0.5 }}> Â· {set.distance} km</span> : null}{set.heartRate ? <span style={{ opacity: 0.5 }}> Â· {set.heartRate} bpm</span> : null}</>;
  if (type === "c") return <>{set.minutes} min{set.heartRate ? <span style={{ opacity: 0.5 }}> Â· {set.heartRate} bpm</span> : null}</>;
  if (type === "b") return `${set.reps} reps`;
  return <>{set.weight} kg <span style={{ opacity: 0.5 }}>Ã—</span> {set.reps} reps</>;
};

function WorkoutTracker() {
  const [customExercises, setCustomExercises] = useState({});
  const [workouts, setWorkouts] = useState([]);
  const [view, setView] = useState("home");
  const [activeWorkout, setActiveWorkout] = useState(null);
  const [selectedWorkout, setSelectedWorkout] = useState(null);
  const [exerciseFilter, setExerciseFilter] = useState(null);
  const [progressExercise, setProgressExercise] = useState(null);
  const [loaded, setLoaded] = useState(false);
  const [searchQuery, setSearchQuery] = useState("");
  const [showNewExercise, setShowNewExercise] = useState(false);
  const [newExName, setNewExName] = useState("");
  const [newExGroup, setNewExGroup] = useState("Pecho");
  const [newExType, setNewExType] = useState("s");
  const [prevView, setPrevView] = useState("home");
  const [editingWorkout, setEditingWorkout] = useState(null);
  const [circuitConfig, setCircuitConfig] = useState(null); // { rounds, workTime, restTime }

  // â”€â”€ Custom foods â”€â”€
  const [customFoods, setCustomFoods] = useState([]);
  const [showNewFood, setShowNewFood] = useState(false);
  const [newFoodName, setNewFoodName] = useState("");
  const [newFoodGroup, setNewFoodGroup] = useState("Base");
  const [newFoodCal, setNewFoodCal] = useState("");
  const [newFoodProt, setNewFoodProt] = useState("");

  // â”€â”€ Nutrition state â”€â”€
  const [nutritionLog, setNutritionLog] = useState({}); // { "2026-02-08": { meals: [...], basalCal: 2000, activityCal: 0 } }
  const [weightLog, setWeightLog] = useState([]); // [{ date: "2026-02-08", weight: 80 }]
  const [nutSettings, setNutSettings] = useState({ basalCal: 2000, protTarget: 150 });
  const [nutDate, setNutDate] = useState(new Date().toISOString().slice(0, 10));
  const [nutView, setNutView] = useState("summary"); // summary | addMeal | addManual | weightLog
  const [nutFoodFilter, setNutFoodFilter] = useState(null);
  const [nutFoodSearch, setNutFoodSearch] = useState("");
  const [nutSelectedFood, setNutSelectedFood] = useState(null);
  const [nutGrams, setNutGrams] = useState("100");
  const [nutManualName, setNutManualName] = useState("");
  const [nutManualCal, setNutManualCal] = useState("");
  const [nutManualProt, setNutManualProt] = useState("");
  const [nutNewWeight, setNutNewWeight] = useState("");
  const [nutEditingMeal, setNutEditingMeal] = useState(null);
  const [nutChartFilter, setNutChartFilter] = useState("1m");
  const [nutShowChart, setNutShowChart] = useState(false);
  const [nutExportFilter, setNutExportFilter] = useState("all");

  // â”€â”€ Plans state â”€â”€
  const [plans, setPlans] = useState([]);
  const [editingPlan, setEditingPlan] = useState(null);

  // â”€â”€ Coach IA state â”€â”€
  const [chatMessages, setChatMessages] = useState([]);
  const [chatInput, setChatInput] = useState("");
  const [chatLoading, setChatLoading] = useState(false);
  const [chatError, setChatError] = useState(null);
  const [geminiKey, setGeminiKey] = useState("");
  const [coachContext, setCoachContext] = useState("");
  const [coachLength, setCoachLength] = useState("normal"); // conciso | normal | detallado
  const chatEndRef = useRef(null);
  const chatInputRef = useRef(null);

  const EXERCISES = useMemo(() => {
    const merged = {};
    for (const [group, exs] of Object.entries(DEFAULT_EXERCISES)) merged[group] = [...exs];
    for (const [group, exs] of Object.entries(customExercises)) {
      if (!merged[group]) merged[group] = [];
      merged[group].push(...exs);
    }
    return merged;
  }, [customExercises]);

  const ALL_EXERCISES = useMemo(
    () => Object.entries(EXERCISES).flatMap(([group, exs]) => exs.map((e) => ({ ...e, group }))),
    [EXERCISES]
  );

  const getExerciseInfo = (id) => ALL_EXERCISES.find((e) => e.id === id);

  const ALL_FOODS = useMemo(() => [...FOOD_DB, ...customFoods], [customFoods]);
  const ALL_FOOD_GROUPS = useMemo(() => [...new Set(ALL_FOODS.map((f) => f.group))], [ALL_FOODS]);

  useEffect(() => {
    (() => {
      try { const r = localStorage.getItem(STORAGE_KEY); if (r) setWorkouts(JSON.parse(r)); } catch {}
      try { const r = localStorage.getItem(CUSTOM_EXERCISES_KEY); if (r) setCustomExercises(JSON.parse(r)); } catch {}
      try { const r = localStorage.getItem(CUSTOM_FOODS_KEY); if (r) setCustomFoods(JSON.parse(r)); } catch {}
      try { const r = localStorage.getItem(NUTRITION_KEY); if (r) setNutritionLog(JSON.parse(r)); } catch {}
      try { const r = localStorage.getItem(WEIGHT_KEY); if (r) setWeightLog(JSON.parse(r)); } catch {}
      try { const r = localStorage.getItem(NUTRITION_SETTINGS_KEY); if (r) setNutSettings(JSON.parse(r)); } catch {}
      try { const r = localStorage.getItem(PLANS_KEY); if (r) setPlans(JSON.parse(r)); } catch {}
      try { const r = localStorage.getItem(CHAT_KEY); if (r) setChatMessages(JSON.parse(r)); } catch {}
      try { const r = localStorage.getItem(GEMINI_KEY); if (r) setGeminiKey(r); } catch {}
      try { const r = localStorage.getItem(COACH_CONTEXT_KEY); if (r) setCoachContext(r); } catch {}
      try { const r = localStorage.getItem(COACH_LENGTH_KEY); if (r) setCoachLength(r); } catch {}
      try { const r = localStorage.getItem(ACTIVE_WORKOUT_KEY); if (r) { const saved = JSON.parse(r); setActiveWorkout(saved.workout); setView(saved.view); } } catch {}
      setLoaded(true);
    })();
  }, []);

  useEffect(() => { if (loaded) { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(workouts)); } catch {} } }, [workouts, loaded]);
  useEffect(() => { if (loaded) { try { localStorage.setItem(CUSTOM_EXERCISES_KEY, JSON.stringify(customExercises)); } catch {} } }, [customExercises, loaded]);
  useEffect(() => { if (loaded) { try { localStorage.setItem(CUSTOM_FOODS_KEY, JSON.stringify(customFoods)); } catch {} } }, [customFoods, loaded]);
  useEffect(() => { if (loaded) { try { localStorage.setItem(NUTRITION_KEY, JSON.stringify(nutritionLog)); } catch {} } }, [nutritionLog, loaded]);
  useEffect(() => { if (loaded) { try { localStorage.setItem(WEIGHT_KEY, JSON.stringify(weightLog)); } catch {} } }, [weightLog, loaded]);
  useEffect(() => { if (loaded) { try { localStorage.setItem(NUTRITION_SETTINGS_KEY, JSON.stringify(nutSettings)); } catch {} } }, [nutSettings, loaded]);
  useEffect(() => { if (loaded) { try { localStorage.setItem(PLANS_KEY, JSON.stringify(plans)); } catch {} } }, [plans, loaded]);
  useEffect(() => { if (loaded) { try { localStorage.setItem(CHAT_KEY, JSON.stringify(chatMessages)); } catch {} } }, [chatMessages, loaded]);
  useEffect(() => { if (loaded) { try { localStorage.setItem(GEMINI_KEY, geminiKey); } catch {} } }, [geminiKey, loaded]);
  useEffect(() => { if (loaded) { try { localStorage.setItem(COACH_CONTEXT_KEY, coachContext); } catch {} } }, [coachContext, loaded]);
  useEffect(() => { if (loaded) { try { localStorage.setItem(COACH_LENGTH_KEY, coachLength); } catch {} } }, [coachLength, loaded]);
  useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [chatMessages, chatLoading]);
  useEffect(() => { if (view === "coach") setTimeout(() => chatEndRef.current?.scrollIntoView({ behavior: "auto" }), 50); }, [view]);
  useEffect(() => { if (!loaded) return; try { if (activeWorkout) { localStorage.setItem(ACTIVE_WORKOUT_KEY, JSON.stringify({ workout: activeWorkout, view })); } else { localStorage.removeItem(ACTIVE_WORKOUT_KEY); } } catch {} }, [activeWorkout, view, loaded]);

  const backupAllData = () => {
    const data = {
      version: 1,
      date: new Date().toISOString(),
      workouts,
      nutritionLog,
      weightLog,
      nutSettings,
      customExercises,
      customFoods,
      chatMessages,
      geminiKey,
      coachContext,
      coachLength,
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `tracker-backup-${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const restoreFromBackup = (file) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        if (!data.workouts && !data.nutritionLog) { alert("Archivo no vÃ¡lido"); return; }
        if (!confirm(`Â¿Restaurar backup del ${new Date(data.date).toLocaleDateString("es-ES")}? Esto reemplazarÃ¡ TODOS los datos actuales.`)) return;
        if (data.workouts) setWorkouts(data.workouts);
        if (data.nutritionLog) setNutritionLog(data.nutritionLog);
        if (data.weightLog) setWeightLog(data.weightLog);
        if (data.nutSettings) setNutSettings(data.nutSettings);
        if (data.customExercises) setCustomExercises(data.customExercises);
        if (data.customFoods) setCustomFoods(data.customFoods);
        if (data.chatMessages) setChatMessages(data.chatMessages);
        if (data.geminiKey) setGeminiKey(data.geminiKey);
        if (data.coachContext) setCoachContext(data.coachContext);
        if (data.coachLength) setCoachLength(data.coachLength);
        setNutView("summary");
        alert("Datos restaurados correctamente");
      } catch { alert("Error al leer el archivo de backup"); }
    };
    reader.readAsText(file);
  };

  const startWorkout = () => { setActiveWorkout({ exercises: [], date: new Date().toISOString() }); setView("workout"); };

  const startCircuitSetup = () => {
    setCircuitConfig({ rounds: 4, workTime: 40, restTime: 20 });
    setActiveWorkout({ exercises: [], date: new Date().toISOString() });
    setView("circuit-setup");
  };

  const saveCircuit = () => {
    if (!activeWorkout || activeWorkout.exercises.length === 0 || !circuitConfig) return;
    const w = {
      id: Date.now().toString(),
      date: activeWorkout.date,
      circuit: { ...circuitConfig, completedRounds: circuitConfig.rounds },
      exercises: activeWorkout.exercises.map((ex) => ({ exerciseId: ex.exerciseId, sets: [] })),
    };
    setWorkouts((prev) => [w, ...prev]);
    setActiveWorkout(null);
    setCircuitConfig(null);
    setView("home");
  };

  // Generic workout state updater â€” works for both active and editing
  const getWState = () => editingWorkout ? [editingWorkout, setEditingWorkout] : [activeWorkout, setActiveWorkout];

  const addExerciseToWorkout = (exercise) => {
    if (editingPlan) { addExerciseToPlan(exercise); return; }
    const info = getExerciseInfo(exercise.id) || exercise;
    const [, setter] = getWState();
    setter((w) => ({
      ...w,
      exercises: [...w.exercises, { exerciseId: exercise.id, sets: [{ ...emptySet(info.type || "s"), done: !!editingWorkout }] }],
    }));
    setView(editingWorkout ? "detail" : circuitConfig ? "circuit-setup" : "workout"); setExerciseFilter(null); setSearchQuery("");
  };

  const updateSet = (exIdx, setIdx, field, value) => {
    const [, setter] = getWState();
    setter((w) => {
      const exercises = [...w.exercises];
      const sets = [...exercises[exIdx].sets];
      sets[setIdx] = { ...sets[setIdx], [field]: value };
      exercises[exIdx] = { ...exercises[exIdx], sets };
      return { ...w, exercises };
    });
  };

  const toggleSetDone = (exIdx, setIdx) => {
    const [wk] = getWState();
    updateSet(exIdx, setIdx, "done", !wk.exercises[exIdx].sets[setIdx].done);
  };

  const addSet = (exIdx) => {
    const [, setter] = getWState();
    setter((w) => {
      const exercises = [...w.exercises];
      const info = getExerciseInfo(exercises[exIdx].exerciseId);
      const lastSet = exercises[exIdx].sets[exercises[exIdx].sets.length - 1];
      const newS = { ...emptySet(info?.type || "s"), done: !!editingWorkout };
      if (info?.type === "t") { newS.seconds = lastSet?.seconds || ""; newS.distance = lastSet?.distance || ""; newS.heartRate = lastSet?.heartRate || ""; }
      else if (info?.type === "c") { newS.minutes = lastSet?.minutes || ""; newS.heartRate = lastSet?.heartRate || ""; }
      else if (info?.type === "b") newS.reps = lastSet?.reps || "";
      else { newS.weight = lastSet?.weight || ""; newS.reps = lastSet?.reps || ""; }
      exercises[exIdx] = { ...exercises[exIdx], sets: [...exercises[exIdx].sets, newS] };
      return { ...w, exercises };
    });
  };

  const removeSet = (exIdx, setIdx) => {
    const [, setter] = getWState();
    setter((w) => {
      const exercises = [...w.exercises];
      const sets = exercises[exIdx].sets.filter((_, i) => i !== setIdx);
      if (sets.length === 0) return { ...w, exercises: exercises.filter((_, i) => i !== exIdx) };
      exercises[exIdx] = { ...exercises[exIdx], sets };
      return { ...w, exercises };
    });
  };

  const removeExercise = (exIdx) => {
    const [, setter] = getWState();
    setter((w) => ({ ...w, exercises: w.exercises.filter((_, i) => i !== exIdx) }));
  };

  // Edit mode
  const startEditing = () => {
    setEditingWorkout(JSON.parse(JSON.stringify(selectedWorkout)));
  };

  const cancelEditing = () => { setEditingWorkout(null); };

  const saveEditing = () => {
    if (!editingWorkout) return;
    const cleaned = {
      ...editingWorkout,
      exercises: editingWorkout.exercises
        .map((ex) => { const info = getExerciseInfo(ex.exerciseId); return { ...ex, sets: ex.sets.filter((s) => isSetValid(s, info?.type || "s")) }; })
        .filter((ex) => ex.sets.length > 0),
    };
    setWorkouts((prev) => prev.map((w) => w.id === cleaned.id ? cleaned : w));
    setSelectedWorkout(cleaned);
    setEditingWorkout(null);
  };

  const finishWorkout = () => {
    if (!activeWorkout || activeWorkout.exercises.length === 0) { setActiveWorkout(null); setView("home"); return; }
    const cleaned = {
      ...activeWorkout, id: Date.now().toString(),
      exercises: activeWorkout.exercises
        .map((ex) => { const info = getExerciseInfo(ex.exerciseId); return { ...ex, sets: ex.sets.filter((s) => isSetValid(s, info?.type || "s")) }; })
        .filter((ex) => ex.sets.length > 0),
    };
    if (cleaned.exercises.length > 0) setWorkouts((prev) => [cleaned, ...prev]);
    setActiveWorkout(null); setView("home");
  };

  const deleteWorkout = (id) => { setWorkouts((prev) => prev.filter((w) => w.id !== id)); setSelectedWorkout(null); setEditingWorkout(null); setView("history"); };

  // â”€â”€ Plan management â”€â”€
  const createNewPlan = () => {
    setEditingPlan({ id: Date.now().toString(), name: "", createdAt: new Date().toISOString(), exercises: [] });
    setView("plan-edit");
  };

  const editPlan = (plan) => {
    setEditingPlan(JSON.parse(JSON.stringify(plan)));
    setView("plan-edit");
  };

  const savePlan = () => {
    if (!editingPlan) return;
    const plan = { ...editingPlan, name: editingPlan.name.trim() || "Plan sin nombre" };
    setPlans((prev) => {
      const idx = prev.findIndex((p) => p.id === plan.id);
      return idx >= 0 ? prev.map((p) => p.id === plan.id ? plan : p) : [...prev, plan];
    });
    setEditingPlan(null);
    setView("plans");
  };

  const deletePlan = (id) => {
    setPlans((prev) => prev.filter((p) => p.id !== id));
  };

  const getExerciseMaxWeight = (exerciseId) => {
    let maxW = 0, repsAtMax = 0;
    for (const w of workouts) for (const ex of w.exercises) if (ex.exerciseId === exerciseId) {
      for (const s of ex.sets) {
        const sw = Number(s.weight) || 0;
        if (sw > maxW) { maxW = sw; repsAtMax = Number(s.reps) || 0; }
      }
    }
    return maxW > 0 ? { weight: maxW, reps: repsAtMax } : null;
  };

  const addExerciseToPlan = (exercise) => {
    const best = getExerciseMaxWeight(exercise.id);
    setEditingPlan((p) => ({
      ...p,
      exercises: [...p.exercises, {
        exerciseId: exercise.id, numSets: 3,
        reps: best ? String(best.reps) : "",
        weight: best ? String(best.weight) : "",
      }],
    }));
    setView("plan-edit");
    setExerciseFilter(null);
    setSearchQuery("");
  };

  const updatePlanExercise = (idx, field, value) => {
    setEditingPlan((p) => {
      const exercises = [...p.exercises];
      exercises[idx] = { ...exercises[idx], [field]: value };
      return { ...p, exercises };
    });
  };

  const removeExerciseFromPlan = (idx) => {
    setEditingPlan((p) => ({ ...p, exercises: p.exercises.filter((_, i) => i !== idx) }));
  };

  const updatePlanSets = (idx, delta) => {
    setEditingPlan((p) => {
      const exercises = [...p.exercises];
      exercises[idx] = { ...exercises[idx], numSets: Math.max(1, exercises[idx].numSets + delta) };
      return { ...p, exercises };
    });
  };

  const loadPlanAsWorkout = (plan) => {
    if (activeWorkout && activeWorkout.exercises.length > 0) {
      if (!confirm("Tienes un entrenamiento en curso. Â¿Descartarlo y cargar el plan?")) return;
    }
    const exercises = plan.exercises
      .filter((ex) => getExerciseInfo(ex.exerciseId))
      .map((ex) => {
        const info = getExerciseInfo(ex.exerciseId);
        const num = (v) => String(v).replace(/[^0-9.]/g, "");
        const base = emptySet(info.type || "s");
        if ("weight" in base && ex.weight) base.weight = num(ex.weight);
        if ("reps" in base && ex.reps) base.reps = num(ex.reps);
        if ("seconds" in base && ex.reps) base.seconds = num(ex.reps);
        return {
          exerciseId: ex.exerciseId,
          sets: Array.from({ length: ex.numSets }, () => ({ ...base, done: false })),
        };
      });
    setActiveWorkout({ exercises, date: new Date().toISOString() });
    setView("workout");
  };

  const saveWorkoutAsPlan = (workout) => {
    const plan = {
      id: Date.now().toString(),
      name: workout.exercises.map((e) => getExerciseInfo(e.exerciseId)?.group).filter((v, i, a) => a.indexOf(v) === i).join(" + ") || "Plan sin nombre",
      createdAt: new Date().toISOString(),
      exercises: workout.exercises.map((ex) => {
        const best = ex.sets.reduce((b, s) => {
          const w = Number(s.weight) || 0;
          return w > (Number(b.weight) || 0) ? { weight: String(w), reps: s.reps || "" } : b;
        }, { weight: "", reps: ex.sets[0]?.reps || "" });
        return { exerciseId: ex.exerciseId, numSets: ex.sets.length, reps: best.reps, weight: best.weight };
      }),
    };
    setPlans((prev) => [...prev, plan]);
  };

  const addCustomExercise = () => {
    if (!newExName.trim()) return;
    const id = "custom_" + Date.now();
    setCustomExercises((prev) => {
      const group = prev[newExGroup] || [];
      return { ...prev, [newExGroup]: [...group, { id, name: newExName.trim(), emoji: "â­", type: newExType }] };
    });
    setNewExName(""); setShowNewExercise(false);
  };

  const deleteCustomExercise = (id) => {
    setCustomExercises((prev) => {
      const updated = {};
      for (const [group, exs] of Object.entries(prev)) {
        const filtered = exs.filter((e) => e.id !== id);
        if (filtered.length > 0) updated[group] = filtered;
      }
      return updated;
    });
  };

  const addCustomFood = () => {
    if (!newFoodName.trim() || !newFoodCal) return;
    const food = { id: "custom_food_" + Date.now(), name: newFoodName.trim(), group: newFoodGroup, cal: Number(newFoodCal) || 0, prot: Number(newFoodProt) || 0 };
    setCustomFoods((prev) => [...prev, food]);
    setNewFoodName(""); setNewFoodCal(""); setNewFoodProt(""); setNewFoodGroup("Base"); setShowNewFood(false);
  };

  const deleteCustomFood = (id) => {
    setCustomFoods((prev) => prev.filter((f) => f.id !== id));
  };

  const getProgression = (exerciseId) => {
    const info = getExerciseInfo(exerciseId);
    const t = info?.type || "s";
    const data = [];
    workouts.forEach((w) => {
      w.exercises.forEach((ex) => {
        if (ex.exerciseId === exerciseId) {
          if (t === "t") {
            const best = ex.sets.reduce((b, s) => Math.max(b, Number(s.seconds || 0)), 0);
            const bestDist = ex.sets.reduce((b, s) => Math.max(b, Number(s.distance || 0)), 0);
            if (best > 0) data.push({ date: w.date, seconds: best, distance: bestDist || undefined });
          } else if (t === "c") {
            const bestMin = ex.sets.reduce((b, s) => Math.max(b, Number(s.minutes || 0)), 0);
            const bestHr = ex.sets.reduce((b, s) => Math.max(b, Number(s.heartRate || 0)), 0);
            if (bestMin > 0) data.push({ date: w.date, minutes: bestMin, heartRate: bestHr || undefined });
          } else if (t === "b") {
            const best = ex.sets.reduce((b, s) => Math.max(b, Number(s.reps || 0)), 0);
            if (best > 0) data.push({ date: w.date, reps: best });
          } else {
            const bestSet = ex.sets.reduce((b, s) => {
              const vol = Number(s.weight) * Number(s.reps);
              return vol > b.vol ? { ...s, vol } : b;
            }, { vol: 0 });
            if (bestSet.vol > 0) data.push({ date: w.date, weight: Number(bestSet.weight), reps: Number(bestSet.reps), volume: bestSet.vol });
          }
        }
      });
    });
    return data.reverse();
  };

  const totalVolume = (workout) =>
    workout.exercises.reduce((total, ex) => {
      const info = getExerciseInfo(ex.exerciseId);
      if (info?.type !== "s") return total;
      return total + ex.sets.reduce((t, s) => t + Number(s.weight || 0) * Number(s.reps || 0), 0);
    }, 0);

  const totalSets = (workout) => workout.exercises.reduce((t, ex) => t + ex.sets.length, 0);

  const stats = useMemo(() => {
    const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
    const thisWeek = workouts.filter((w) => new Date(w.date) >= weekAgo);
    return { totalWorkouts: workouts.length, thisWeek: thisWeek.length, totalVolume: thisWeek.reduce((t, w) => t + totalVolume(w), 0) };
  }, [workouts]);

  const getPreviousBest = (exerciseId) => {
    for (const w of workouts) for (const ex of w.exercises) if (ex.exerciseId === exerciseId) return ex.sets;
    return null;
  };

  // â”€â”€â”€ STYLES â”€â”€â”€
  const C = {
    bg: "#0a0a0f", card: "#15151e", accent: "#ff6b35",
    accentDim: "rgba(255,107,53,0.15)", accentGlow: "rgba(255,107,53,0.3)",
    text: "#f0eff4", textDim: "#8a8a9a", border: "#252535",
    success: "#34d399", successDim: "rgba(52,211,153,0.15)",
    danger: "#ef4444", dangerDim: "rgba(239,68,68,0.12)",
  };
  const baseCard = { background: C.card, borderRadius: 16, border: `1px solid ${C.border}`, padding: "16px" };
  const font = "'Space Grotesk', sans-serif";
  const fontBody = "'DM Sans', sans-serif";
  const inputStyle = (done) => ({
    padding: "10px 8px", borderRadius: 10, border: `1px solid ${done ? C.success + "40" : C.border}`,
    background: done ? C.successDim : "rgba(255,255,255,0.04)", color: C.text,
    fontSize: 15, textAlign: "center", outline: "none", width: "100%", boxSizing: "border-box", fontWeight: 600,
  });

  // â•â•â• SET ROW RENDERER â•â•â•
  const renderSetRow = (ex, exIdx, set, setIdx) => {
    const info = getExerciseInfo(ex.exerciseId);
    const t = info?.type || "s";

    if (t === "t") {
      const totalSec = Number(set.seconds) || 0;
      const mins = set.seconds ? Math.floor(totalSec / 60) : "";
      const secs = set.seconds ? totalSec % 60 : "";
      const setTime = (newMins, newSecs) => {
        const m = Number(newMins) || 0;
        const s = Number(newSecs) || 0;
        updateSet(exIdx, setIdx, "seconds", String(m * 60 + s));
      };
      return (
        <div key={setIdx} style={{ marginBottom: 10 }}>
          <div style={{ display: "grid", gridTemplateColumns: "36px 1fr 1fr 44px 32px", gap: 8, alignItems: "center" }}>
            <span style={{ fontSize: 13, fontWeight: 700, color: set.done ? C.success : C.textDim, textAlign: "center" }}>{setIdx + 1}</span>
            <input type="number" inputMode="numeric" placeholder="0" value={mins}
              onChange={(e) => setTime(e.target.value, secs)}
              style={inputStyle(set.done)} />
            <input type="number" inputMode="numeric" placeholder="0" value={secs}
              onChange={(e) => setTime(mins, e.target.value)}
              style={inputStyle(set.done)} />
            <button onClick={() => toggleSetDone(exIdx, setIdx)} style={{
              width: 44, height: 40, borderRadius: 10, border: `1px solid ${set.done ? C.success : C.border}`,
              background: set.done ? C.success : "transparent", color: set.done ? "#000" : C.textDim,
              fontSize: 16, cursor: "pointer", fontWeight: 700, display: "flex", alignItems: "center", justifyContent: "center",
            }}>âœ“</button>
            <button onClick={() => removeSet(exIdx, setIdx)} style={{
              width: 32, height: 40, borderRadius: 10, border: "none", background: "transparent", color: C.textDim, fontSize: 16, cursor: "pointer",
            }}>Ã—</button>
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "36px 1fr 1fr 44px 32px", gap: 8, marginTop: 4, alignItems: "center" }}>
            <span></span>
            <div style={{ position: "relative" }}>
              <input type="number" inputMode="decimal" placeholder="â€”" value={set.distance || ""}
                onChange={(e) => updateSet(exIdx, setIdx, "distance", e.target.value)}
                style={{ ...inputStyle(set.done), fontSize: 13, padding: "7px 32px 7px 8px" }} />
              <span style={{ position: "absolute", right: 8, top: "50%", transform: "translateY(-50%)", fontSize: 10, color: C.textDim, pointerEvents: "none" }}>km</span>
            </div>
            <div style={{ position: "relative" }}>
              <input type="number" inputMode="numeric" placeholder="â€”" value={set.heartRate || ""}
                onChange={(e) => updateSet(exIdx, setIdx, "heartRate", e.target.value)}
                style={{ ...inputStyle(set.done), fontSize: 13, padding: "7px 34px 7px 8px" }} />
              <span style={{ position: "absolute", right: 8, top: "50%", transform: "translateY(-50%)", fontSize: 10, color: C.textDim, pointerEvents: "none" }}>bpm</span>
            </div>
            <span></span><span></span>
          </div>
        </div>
      );
    }

    if (t === "c") {
      return (
        <div key={setIdx} style={{ display: "grid", gridTemplateColumns: "36px 1fr 1fr 44px 32px", gap: 8, marginBottom: 6, alignItems: "center" }}>
          <span style={{ fontSize: 13, fontWeight: 700, color: set.done ? C.success : C.textDim, textAlign: "center" }}>{setIdx + 1}</span>
          <div style={{ position: "relative" }}>
            <input type="number" inputMode="numeric" placeholder="0" value={set.minutes || ""}
              onChange={(e) => updateSet(exIdx, setIdx, "minutes", e.target.value)}
              style={{ ...inputStyle(set.done), paddingRight: 34 }} />
            <span style={{ position: "absolute", right: 8, top: "50%", transform: "translateY(-50%)", fontSize: 10, color: C.textDim, pointerEvents: "none" }}>min</span>
          </div>
          <div style={{ position: "relative" }}>
            <input type="number" inputMode="numeric" placeholder="â€”" value={set.heartRate || ""}
              onChange={(e) => updateSet(exIdx, setIdx, "heartRate", e.target.value)}
              style={{ ...inputStyle(set.done), paddingRight: 34 }} />
            <span style={{ position: "absolute", right: 8, top: "50%", transform: "translateY(-50%)", fontSize: 10, color: C.textDim, pointerEvents: "none" }}>bpm</span>
          </div>
          <button onClick={() => toggleSetDone(exIdx, setIdx)} style={{
            width: 44, height: 40, borderRadius: 10, border: `1px solid ${set.done ? C.success : C.border}`,
            background: set.done ? C.success : "transparent", color: set.done ? "#000" : C.textDim,
            fontSize: 16, cursor: "pointer", fontWeight: 700, display: "flex", alignItems: "center", justifyContent: "center",
          }}>âœ“</button>
          <button onClick={() => removeSet(exIdx, setIdx)} style={{
            width: 32, height: 40, borderRadius: 10, border: "none", background: "transparent", color: C.textDim, fontSize: 16, cursor: "pointer",
          }}>Ã—</button>
        </div>
      );
    }

    if (t === "b") {
      return (
        <div key={setIdx} style={{ display: "grid", gridTemplateColumns: "36px 1fr 44px 32px", gap: 8, marginBottom: 6, alignItems: "center" }}>
          <span style={{ fontSize: 13, fontWeight: 700, color: set.done ? C.success : C.textDim, textAlign: "center" }}>{setIdx + 1}</span>
          <input type="number" inputMode="numeric" placeholder="0" value={set.reps}
            onChange={(e) => updateSet(exIdx, setIdx, "reps", e.target.value)}
            style={inputStyle(set.done)} />
          <button onClick={() => toggleSetDone(exIdx, setIdx)} style={{
            width: 44, height: 40, borderRadius: 10, border: `1px solid ${set.done ? C.success : C.border}`,
            background: set.done ? C.success : "transparent", color: set.done ? "#000" : C.textDim,
            fontSize: 16, cursor: "pointer", fontWeight: 700, display: "flex", alignItems: "center", justifyContent: "center",
          }}>âœ“</button>
          <button onClick={() => removeSet(exIdx, setIdx)} style={{
            width: 32, height: 40, borderRadius: 10, border: "none", background: "transparent", color: C.textDim, fontSize: 16, cursor: "pointer",
          }}>Ã—</button>
        </div>
      );
    }

    // Standard: kg + reps
    return (
      <div key={setIdx} style={{ display: "grid", gridTemplateColumns: "36px 1fr 1fr 44px 32px", gap: 8, marginBottom: 6, alignItems: "center" }}>
        <span style={{ fontSize: 13, fontWeight: 700, color: set.done ? C.success : C.textDim, textAlign: "center" }}>{setIdx + 1}</span>
        <input type="number" inputMode="decimal" placeholder="0" value={set.weight}
          onChange={(e) => updateSet(exIdx, setIdx, "weight", e.target.value)} style={inputStyle(set.done)} />
        <input type="number" inputMode="numeric" placeholder="0" value={set.reps}
          onChange={(e) => updateSet(exIdx, setIdx, "reps", e.target.value)} style={inputStyle(set.done)} />
        <button onClick={() => toggleSetDone(exIdx, setIdx)} style={{
          width: 44, height: 40, borderRadius: 10, border: `1px solid ${set.done ? C.success : C.border}`,
          background: set.done ? C.success : "transparent", color: set.done ? "#000" : C.textDim,
          fontSize: 16, cursor: "pointer", fontWeight: 700, display: "flex", alignItems: "center", justifyContent: "center",
        }}>âœ“</button>
        <button onClick={() => removeSet(exIdx, setIdx)} style={{
          width: 32, height: 40, borderRadius: 10, border: "none", background: "transparent", color: C.textDim, fontSize: 16, cursor: "pointer",
        }}>Ã—</button>
      </div>
    );
  };

  const renderSetHeader = (type) => {
    if (type === "t") return (
      <div style={{ display: "grid", gridTemplateColumns: "36px 1fr 1fr 44px 32px", gap: 8, marginBottom: 8, padding: "0 2px" }}>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>SET</span>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>MIN</span>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>SEG</span>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>âœ“</span><span></span>
      </div>
    );
    if (type === "c") return (
      <div style={{ display: "grid", gridTemplateColumns: "36px 1fr 1fr 44px 32px", gap: 8, marginBottom: 8, padding: "0 2px" }}>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>SET</span>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>MIN</span>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>BPM</span>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>âœ“</span><span></span>
      </div>
    );
    if (type === "b") return (
      <div style={{ display: "grid", gridTemplateColumns: "36px 1fr 44px 32px", gap: 8, marginBottom: 8, padding: "0 2px" }}>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>SET</span>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>REPS</span>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>âœ“</span><span></span>
      </div>
    );
    return (
      <div style={{ display: "grid", gridTemplateColumns: "36px 1fr 1fr 44px 32px", gap: 8, marginBottom: 8, padding: "0 2px" }}>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>SET</span>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>KG</span>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>REPS</span>
        <span style={{ fontSize: 11, color: C.textDim, textAlign: "center" }}>âœ“</span><span></span>
      </div>
    );
  };

  // â•â•â• HOME â•â•â•
  const repeatWorkout = (w) => {
    if (w.circuit) {
      setCircuitConfig({ rounds: w.circuit.rounds, workTime: w.circuit.workTime, restTime: w.circuit.restTime });
      setActiveWorkout({ exercises: w.exercises.map((ex) => ({ exerciseId: ex.exerciseId, sets: [] })), date: new Date().toISOString() });
      setView("circuit-setup");
      return;
    }
    const newExercises = w.exercises.map((ex) => {
      const info = getExerciseInfo(ex.exerciseId);
      const t = info?.type || "s";
      return {
        exerciseId: ex.exerciseId,
        sets: ex.sets.map((s) => {
          if (t === "t") return { seconds: s.seconds || "", distance: s.distance || "", heartRate: s.heartRate || "", done: false };
          if (t === "c") return { minutes: s.minutes || "", heartRate: s.heartRate || "", done: false };
          if (t === "b") return { reps: s.reps || "", done: false };
          return { weight: s.weight || "", reps: s.reps || "", done: false };
        }),
      };
    });
    setActiveWorkout({ exercises: newExercises, date: new Date().toISOString() });
    setView("workout");
  };

  // â•â•â• CIRCUIT SETUP â•â•â•
  const removeCircuitExercise = (idx) => {
    setActiveWorkout((w) => ({ ...w, exercises: w.exercises.filter((_, i) => i !== idx) }));
  };

  const renderCircuitSetup = () => {
    if (!circuitConfig) return null;
    const stepBtn = { width: 44, height: 44, borderRadius: 12, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 20, fontWeight: 700, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center" };
    const exCount = activeWorkout?.exercises.length || 0;
    const estSec = circuitConfig.rounds * exCount * (circuitConfig.workTime + circuitConfig.restTime);

    return (
      <div style={{ padding: "0 20px 100px" }}>
        <div style={{ paddingTop: 16, marginBottom: 20, display: "flex", alignItems: "center", gap: 12 }}>
          <button onClick={() => { setCircuitConfig(null); setActiveWorkout(null); setView("home"); }}
            style={{ background: "none", border: "none", color: C.accent, fontSize: 28, cursor: "pointer", padding: 0 }}>â€¹</button>
          <h1 style={{ fontSize: 22, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>Registrar Circuito</h1>
        </div>

        <div style={{ ...baseCard, marginBottom: 16 }}>
          <div style={{ fontSize: 14, fontWeight: 700, color: "#a855f7", marginBottom: 14 }}>ConfiguraciÃ³n</div>

          <div style={{ marginBottom: 14 }}>
            <div style={{ fontSize: 12, color: C.textDim, marginBottom: 8 }}>RONDAS</div>
            <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
              <button onClick={() => setCircuitConfig((p) => ({ ...p, rounds: Math.max(1, p.rounds - 1) }))} style={stepBtn}>âˆ’</button>
              <span style={{ fontSize: 28, fontWeight: 800, color: C.text, minWidth: 40, textAlign: "center", fontFamily: font }}>{circuitConfig.rounds}</span>
              <button onClick={() => setCircuitConfig((p) => ({ ...p, rounds: Math.min(20, p.rounds + 1) }))} style={stepBtn}>+</button>
            </div>
          </div>

          <div style={{ marginBottom: 14 }}>
            <div style={{ fontSize: 12, color: C.textDim, marginBottom: 8 }}>TRABAJO (seg)</div>
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
              {[20, 30, 40, 45, 50, 60].map((t) => (
                <button key={t} onClick={() => setCircuitConfig((p) => ({ ...p, workTime: t }))} style={{
                  padding: "8px 14px", borderRadius: 10, fontSize: 14, fontWeight: 600, cursor: "pointer",
                  border: `1px solid ${circuitConfig.workTime === t ? "#a855f7" : C.border}`,
                  background: circuitConfig.workTime === t ? "rgba(168,85,247,0.15)" : "transparent",
                  color: circuitConfig.workTime === t ? "#a855f7" : C.textDim,
                }}>{t}s</button>
              ))}
            </div>
          </div>

          <div>
            <div style={{ fontSize: 12, color: C.textDim, marginBottom: 8 }}>DESCANSO (seg)</div>
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
              {[10, 15, 20, 25, 30].map((t) => (
                <button key={t} onClick={() => setCircuitConfig((p) => ({ ...p, restTime: t }))} style={{
                  padding: "8px 14px", borderRadius: 10, fontSize: 14, fontWeight: 600, cursor: "pointer",
                  border: `1px solid ${circuitConfig.restTime === t ? "#a855f7" : C.border}`,
                  background: circuitConfig.restTime === t ? "rgba(168,85,247,0.15)" : "transparent",
                  color: circuitConfig.restTime === t ? "#a855f7" : C.textDim,
                }}>{t}s</button>
              ))}
            </div>
          </div>
        </div>

        <div style={{ ...baseCard, marginBottom: 16 }}>
          <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 12 }}>Ejercicios ({exCount})</div>
          {activeWorkout?.exercises.map((ex, i) => {
            const info = getExerciseInfo(ex.exerciseId);
            return (
              <div key={i} style={{ display: "flex", alignItems: "center", gap: 10, padding: "10px 0",
                borderBottom: i < exCount - 1 ? `1px solid ${C.border}` : "none" }}>
                <span style={{ fontSize: 12, color: C.textDim, width: 24, textAlign: "center" }}>{i + 1}</span>
                <span style={{ fontSize: 18 }}>{info?.emoji || "â­"}</span>
                <span style={{ flex: 1, fontSize: 14, fontWeight: 600, color: C.text }}>{info?.name || ex.exerciseId}</span>
                <button onClick={() => removeCircuitExercise(i)}
                  style={{ background: "none", border: "none", color: C.textDim, fontSize: 16, cursor: "pointer", padding: "4px 8px" }}>âœ•</button>
              </div>
            );
          })}
          <button onClick={() => setView("picker")} style={{
            width: "100%", padding: "12px", borderRadius: 10, border: `1px dashed ${C.accent}40`,
            background: C.accentDim, color: C.accent, fontSize: 14, fontWeight: 600, cursor: "pointer", marginTop: 10,
          }}>+ AÃ±adir Ejercicio</button>
        </div>

        {exCount > 0 && (
          <div style={{ textAlign: "center", fontSize: 13, color: C.textDim, marginBottom: 16 }}>
            DuraciÃ³n estimada: ~{fmtSec(estSec)}
          </div>
        )}

        <button onClick={saveCircuit} disabled={exCount === 0} style={{
          width: "100%", padding: "18px", borderRadius: 16, border: "none",
          background: exCount > 0 ? "linear-gradient(135deg, #a855f7, #c084fc)" : C.card,
          color: exCount > 0 ? "#fff" : C.textDim,
          fontSize: 17, fontWeight: 700, cursor: exCount > 0 ? "pointer" : "default",
          boxShadow: exCount > 0 ? "0 4px 24px rgba(168,85,247,0.3)" : "none",
        }}>Guardar Circuito</button>
      </div>
    );
  };

  const renderHome = () => {
    return (
    <div style={{ padding: "0 20px 100px" }}>
      <div style={{ paddingTop: 16, marginBottom: 28 }}>
        <p style={{ color: C.textDim, fontSize: 14, marginBottom: 4, fontFamily: fontBody }}>
          {new Date().toLocaleDateString("es-ES", { weekday: "long", day: "numeric", month: "long" })}
        </p>
        <h1 style={{ fontSize: 28, fontWeight: 800, color: C.text, margin: 0, fontFamily: font, letterSpacing: "-0.5px" }}>Tu Entreno ğŸ”¥</h1>
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 10, marginBottom: 24 }}>
        {[
          { label: "Esta semana", value: stats.thisWeek, hl: true },
          { label: "Volumen 7d", value: stats.totalVolume > 1000 ? `${(stats.totalVolume / 1000).toFixed(1)}k` : stats.totalVolume },
          { label: "Total", value: stats.totalWorkouts },
        ].map((s, i) => (
          <div key={i} style={{ ...baseCard, padding: "14px 12px", textAlign: "center", background: s.hl ? C.accentDim : C.card, borderColor: s.hl ? C.accent : C.border }}>
            <div style={{ fontSize: 24, fontWeight: 800, color: s.hl ? C.accent : C.text, fontFamily: font }}>{s.value}</div>
            <div style={{ fontSize: 11, color: C.textDim, marginTop: 2 }}>{s.label}</div>
          </div>
        ))}
      </div>

      <button onClick={startWorkout} style={{
        width: "100%", padding: "18px", borderRadius: 16, border: "none",
        background: `linear-gradient(135deg, ${C.accent}, #ff8f35)`, color: "#fff",
        fontSize: 17, fontWeight: 700, cursor: "pointer", marginBottom: 10,
        fontFamily: font, boxShadow: `0 4px 24px ${C.accentGlow}`,
      }}>+ Empezar Entrenamiento</button>

      <button onClick={() => setView("plans")} style={{
        width: "100%", padding: "16px", borderRadius: 14, border: `1px solid ${C.border}`,
        background: C.card, color: C.text, fontSize: 16, fontWeight: 700, cursor: "pointer", marginBottom: 10,
        fontFamily: font, display: "flex", alignItems: "center", justifyContent: "center", gap: 10,
      }}>ğŸ“‹ Mis Planes{plans.length > 0 && ` (${plans.length})`}</button>

      <button onClick={startCircuitSetup} style={{
        width: "100%", padding: "16px", borderRadius: 16, border: "none",
        background: "linear-gradient(135deg, #a855f7, #c084fc)", color: "#fff",
        fontSize: 15, fontWeight: 700, cursor: "pointer", marginBottom: 24,
        fontFamily: font, boxShadow: "0 4px 24px rgba(168,85,247,0.3)",
      }}>Registrar Circuito</button>

      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 14 }}>
        <h2 style={{ fontSize: 18, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>Ãšltimas sesiones</h2>
        {workouts.length > 0 && (
          <button onClick={() => setView("history")} style={{
            background: "none", border: "none", color: C.accent, fontSize: 13, fontWeight: 600, cursor: "pointer", padding: 0,
          }}>Ver todo â€º</button>
        )}
      </div>
      {workouts.length === 0 ? (
        <div style={{ ...baseCard, textAlign: "center", padding: "40px 20px", color: C.textDim }}>
          <div style={{ fontSize: 40, marginBottom: 12 }}>ğŸ‹ï¸</div>
          <p style={{ margin: 0, fontSize: 15 }}>AÃºn no hay sesiones</p>
          <p style={{ margin: "8px 0 0", fontSize: 13 }}>Â¡Empieza tu primer entreno!</p>
        </div>
      ) : workouts.slice(0, 5).map((w) => {
        const vol = totalVolume(w);
        return (
          <div key={w.id} style={{ ...baseCard, marginBottom: 10, display: "flex", alignItems: "center" }}>
            <div onClick={() => { setSelectedWorkout(w); setPrevView("home"); setView("detail"); }}
              style={{ flex: 1, cursor: "pointer" }}>
              <div style={{ fontSize: 15, fontWeight: 600, color: C.text, marginBottom: 4, display: "flex", alignItems: "center", gap: 8 }}>
                <span>{w.circuit ? "Circuito" : w.exercises.map((e) => getExerciseInfo(e.exerciseId)?.group).filter((v, i, a) => a.indexOf(v) === i).join(" Â· ") || "SesiÃ³n"}</span>
                {w.circuit && <span style={{ fontSize: 10, padding: "2px 6px", borderRadius: 6, background: "rgba(168,85,247,0.15)", color: "#a855f7", fontWeight: 700 }}>CT</span>}
              </div>
              <div style={{ fontSize: 13, color: C.textDim }}>
                {formatDate(w.date)} Â· {w.circuit ? `${w.circuit.rounds}R Â· ${w.circuit.workTime}s/${w.circuit.restTime}s` : `${totalSets(w)} series${vol > 0 ? ` Â· ${(vol / 1000).toFixed(1)}k kg` : ""}`}
              </div>
            </div>
            <button onClick={(e) => { e.stopPropagation(); repeatWorkout(w); }} title="Repetir entrenamiento" style={{
              background: "none", border: `1px solid ${C.border}`, borderRadius: 8, padding: "6px 8px",
              color: C.accent, fontSize: 16, cursor: "pointer", marginLeft: 8, flexShrink: 0,
            }}>ğŸ”„</button>
          </div>
        );
      })}

    </div>
    );
  };

  // â•â•â• EXERCISE PICKER â•â•â•
  const exerciseFrequency = useMemo(() => {
    const freq = {};
    workouts.forEach((w) => w.exercises.forEach((ex) => { freq[ex.exerciseId] = (freq[ex.exerciseId] || 0) + 1; }));
    return freq;
  }, [workouts]);

  const sortByFrequency = (list) => [...list].sort((a, b) => (exerciseFrequency[b.id] || 0) - (exerciseFrequency[a.id] || 0));

  const renderExercisePicker = () => {
    const q = searchQuery.toLowerCase();
    const hasFrequent = Object.keys(exerciseFrequency).length > 0;

    const filtered = q
      ? sortByFrequency(ALL_EXERCISES.filter((e) => e.name.toLowerCase().includes(q) || e.group.toLowerCase().includes(q)))
      : exerciseFilter
      ? sortByFrequency((EXERCISES[exerciseFilter] || []).map((e) => ({ ...e, group: exerciseFilter })))
      : [];

    // Top frequent exercises when no search/filter
    const frequentExercises = !q && !exerciseFilter && hasFrequent
      ? sortByFrequency(ALL_EXERCISES.filter((e) => exerciseFrequency[e.id])).slice(0, 8)
      : [];

    return (
      <div style={{ padding: "0 20px 100px" }}>
        <div style={{ paddingTop: 16, marginBottom: 20, display: "flex", alignItems: "center", gap: 12 }}>
          <button onClick={() => { setView(editingPlan ? "plan-edit" : editingWorkout ? "detail" : circuitConfig ? "circuit-setup" : "workout"); setExerciseFilter(null); setSearchQuery(""); }}
            style={{ background: "none", border: "none", color: C.accent, fontSize: 28, cursor: "pointer", padding: 0 }}>â€¹</button>
          <h1 style={{ fontSize: 22, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>AÃ±adir Ejercicio</h1>
        </div>

        <input type="text" placeholder="Buscar ejercicio..." value={searchQuery}
          onChange={(e) => { setSearchQuery(e.target.value); setExerciseFilter(null); }}
          style={{
            width: "100%", padding: "14px 16px", borderRadius: 12, border: `1px solid ${C.border}`,
            background: C.card, color: C.text, fontSize: 15, marginBottom: 16, outline: "none",
            boxSizing: "border-box", fontFamily: fontBody,
          }} />

        <button onClick={() => setShowNewExercise(true)} style={{
          width: "100%", padding: "12px", borderRadius: 12, border: `1px dashed ${C.accent}60`,
          background: C.accentDim, color: C.accent, fontSize: 14, fontWeight: 600,
          cursor: "pointer", marginBottom: 16, fontFamily: fontBody,
        }}>â­ Crear ejercicio personalizado</button>

        {showNewExercise && (
          <div style={{ ...baseCard, marginBottom: 16, borderColor: C.accent }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 12 }}>Nuevo ejercicio</div>
            <input type="text" placeholder="Nombre del ejercicio" value={newExName}
              onChange={(e) => setNewExName(e.target.value)}
              style={{
                width: "100%", padding: "12px 14px", borderRadius: 10, border: `1px solid ${C.border}`,
                background: "rgba(255,255,255,0.04)", color: C.text, fontSize: 14, outline: "none",
                boxSizing: "border-box", marginBottom: 10, fontFamily: fontBody,
              }} />
            {/* Group selector */}
            <div style={{ fontSize: 12, color: C.textDim, marginBottom: 6, fontWeight: 600 }}>GRUPO MUSCULAR</div>
            <div style={{ display: "flex", flexWrap: "wrap", gap: 6, marginBottom: 12 }}>
              {Object.keys(DEFAULT_EXERCISES).map((g) => (
                <button key={g} onClick={() => setNewExGroup(g)} style={{
                  padding: "6px 12px", borderRadius: 16, fontSize: 12, fontWeight: 600, cursor: "pointer",
                  border: `1px solid ${newExGroup === g ? C.accent : C.border}`,
                  background: newExGroup === g ? C.accentDim : "transparent",
                  color: newExGroup === g ? C.accent : C.textDim,
                }}>{g}</button>
              ))}
            </div>
            {/* Type selector */}
            <div style={{ fontSize: 12, color: C.textDim, marginBottom: 6, fontWeight: 600 }}>TIPO DE TRACKING</div>
            <div style={{ display: "flex", gap: 8, marginBottom: 14 }}>
              {Object.entries(TYPE_LABELS).map(([k, label]) => (
                <button key={k} onClick={() => setNewExType(k)} style={{
                  flex: 1, padding: "8px", borderRadius: 10, fontSize: 12, fontWeight: 600, cursor: "pointer",
                  border: `1px solid ${newExType === k ? C.accent : C.border}`,
                  background: newExType === k ? C.accentDim : "transparent",
                  color: newExType === k ? C.accent : C.textDim, textAlign: "center",
                }}>{label}</button>
              ))}
            </div>
            <div style={{ display: "flex", gap: 8 }}>
              <button onClick={addCustomExercise} style={{
                flex: 1, padding: "10px", borderRadius: 10, border: "none",
                background: C.accent, color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer",
              }}>AÃ±adir</button>
              <button onClick={() => { setShowNewExercise(false); setNewExName(""); }} style={{
                padding: "10px 16px", borderRadius: 10, border: `1px solid ${C.border}`,
                background: "transparent", color: C.textDim, fontSize: 14, cursor: "pointer",
              }}>Cancelar</button>
            </div>
          </div>
        )}

        {!q && (
          <div style={{ display: "flex", flexWrap: "wrap", gap: 8, marginBottom: 20 }}>
            {Object.keys(EXERCISES).map((group) => (
              <button key={group} onClick={() => setExerciseFilter(exerciseFilter === group ? null : group)}
                style={{
                  padding: "8px 14px", borderRadius: 20, fontSize: 13, fontWeight: 600, cursor: "pointer",
                  border: `1px solid ${exerciseFilter === group ? C.accent : C.border}`,
                  background: exerciseFilter === group ? C.accentDim : C.card,
                  color: exerciseFilter === group ? C.accent : C.textDim,
                }}>{group}</button>
            ))}
          </div>
        )}

        {filtered.length > 0 ? filtered.map((ex) => {
          const isCustom = ex.id.startsWith("custom_");
          const freq = exerciseFrequency[ex.id];
          return (
            <div key={ex.id} style={{ ...baseCard, marginBottom: 8, padding: "12px 16px", display: "flex", alignItems: "center", gap: 12 }}>
              <div onClick={() => addExerciseToWorkout(ex)} style={{ flex: 1, display: "flex", alignItems: "center", gap: 12, cursor: "pointer" }}>
                <span style={{ fontSize: 22 }}>{ex.emoji}</span>
                <div>
                  <div style={{ fontSize: 15, fontWeight: 600, color: C.text }}>{ex.name}</div>
                  <div style={{ fontSize: 12, color: C.textDim }}>
                    {ex.group} Â· <span style={{ color: C.accent }}>{TYPE_TAGS[ex.type || "s"]}</span>
                    {freq && <span style={{ marginLeft: 6 }}>Â· {freq}Ã—</span>}
                  </div>
                </div>
              </div>
              {isCustom && (
                <button onClick={(e) => { e.stopPropagation(); deleteCustomExercise(ex.id); }}
                  style={{ background: "none", border: "none", color: C.danger, fontSize: 16, cursor: "pointer", padding: "4px 8px" }}>âœ•</button>
              )}
            </div>
          );
        }) : frequentExercises.length > 0 ? (
          <>
            <div style={{ fontSize: 13, fontWeight: 700, color: C.accent, marginBottom: 10, textTransform: "uppercase", letterSpacing: 1 }}>Frecuentes</div>
            {frequentExercises.map((ex) => (
              <div key={ex.id} onClick={() => addExerciseToWorkout(ex)}
                style={{ ...baseCard, marginBottom: 8, padding: "12px 16px", display: "flex", alignItems: "center", gap: 12, cursor: "pointer" }}>
                <span style={{ fontSize: 22 }}>{ex.emoji}</span>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 15, fontWeight: 600, color: C.text }}>{ex.name}</div>
                  <div style={{ fontSize: 12, color: C.textDim }}>{ex.group}</div>
                </div>
                <span style={{ fontSize: 12, color: C.textDim, fontWeight: 600 }}>{exerciseFrequency[ex.id]}Ã—</span>
              </div>
            ))}
          </>
        ) : !q && !exerciseFilter ? (
          <div style={{ color: C.textDim, textAlign: "center", padding: 40, fontSize: 14 }}>Selecciona un grupo muscular o busca</div>
        ) : (
          <div style={{ color: C.textDim, textAlign: "center", padding: 40, fontSize: 14 }}>No se encontraron ejercicios</div>
        )}
      </div>
    );
  };

  // â•â•â• PLANS â•â•â•
  const renderPlans = () => (
    <div style={{ padding: "0 20px 100px" }}>
      <div style={{ paddingTop: 16, marginBottom: 20, display: "flex", alignItems: "center", gap: 12 }}>
        <button onClick={() => setView("home")}
          style={{ background: "none", border: "none", color: C.accent, fontSize: 28, cursor: "pointer", padding: 0 }}>â€¹</button>
        <h1 style={{ fontSize: 22, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>Mis Planes</h1>
      </div>

      <button onClick={createNewPlan} style={{
        width: "100%", padding: "16px", borderRadius: 14, border: `2px dashed ${C.accent}40`,
        background: C.accentDim, color: C.accent, fontSize: 15, fontWeight: 600, cursor: "pointer", marginBottom: 20,
      }}>+ Crear nuevo plan</button>

      {plans.length === 0 ? (
        <div style={{ ...baseCard, textAlign: "center", padding: "40px 20px", color: C.textDim }}>
          <div style={{ fontSize: 40, marginBottom: 12 }}>ğŸ“‹</div>
          <p style={{ margin: 0, fontSize: 15 }}>No hay planes guardados</p>
          <p style={{ margin: "8px 0 0", fontSize: 13 }}>Crea un plan o guarda un entrenamiento como plan</p>
        </div>
      ) : plans.map((plan) => {
        const validExercises = plan.exercises.filter((ex) => getExerciseInfo(ex.exerciseId));
        const groups = [...new Set(validExercises.map((ex) => getExerciseInfo(ex.exerciseId)?.group).filter(Boolean))];
        const totalS = validExercises.reduce((t, ex) => t + ex.numSets, 0);
        return (
          <div key={plan.id} style={{ ...baseCard, marginBottom: 10 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 10 }}>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 16, fontWeight: 700, color: C.text, marginBottom: 4 }}>{plan.name}</div>
                <div style={{ fontSize: 13, color: C.textDim }}>
                  {validExercises.length} ejercicios Â· {totalS} series
                  {groups.length > 0 && <span> Â· {groups.join(", ")}</span>}
                </div>
              </div>
            </div>
            <div style={{ display: "flex", flexWrap: "wrap", gap: 6, marginBottom: 12 }}>
              {validExercises.map((ex, i) => {
                const info = getExerciseInfo(ex.exerciseId);
                return (
                  <span key={i} style={{
                    padding: "4px 10px", borderRadius: 8, background: "rgba(255,255,255,0.05)",
                    fontSize: 12, color: C.textDim,
                  }}>{info.emoji} {info.name} {ex.numSets}Ã—{ex.reps || "?"}{ex.weight ? ` ${ex.weight}kg` : ""}</span>
                );
              })}
            </div>
            <div style={{ display: "flex", gap: 8 }}>
              <button onClick={() => loadPlanAsWorkout(plan)} style={{
                flex: 1, padding: "12px", borderRadius: 12, border: "none",
                background: `linear-gradient(135deg, ${C.accent}, #ff8f35)`, color: "#fff",
                fontSize: 14, fontWeight: 700, cursor: "pointer", fontFamily: font,
              }}>â–¶ Empezar</button>
              <button onClick={() => editPlan(plan)} style={{
                padding: "12px 16px", borderRadius: 12, border: `1px solid ${C.border}`,
                background: "transparent", color: C.textDim, fontSize: 14, cursor: "pointer",
              }}>âœï¸</button>
              <button onClick={() => deletePlan(plan.id)} style={{
                padding: "12px 16px", borderRadius: 12, border: `1px solid ${C.danger}40`,
                background: C.dangerDim, color: C.danger, fontSize: 14, cursor: "pointer",
              }}>ğŸ—‘</button>
            </div>
          </div>
        );
      })}
    </div>
  );

  const renderPlanEdit = () => {
    if (!editingPlan) return null;
    return (
      <div style={{ padding: "0 20px 100px" }}>
        <div style={{ paddingTop: 16, marginBottom: 20, display: "flex", alignItems: "center", gap: 12 }}>
          <button onClick={() => { setEditingPlan(null); setView("plans"); }}
            style={{ background: "none", border: "none", color: C.accent, fontSize: 28, cursor: "pointer", padding: 0 }}>â€¹</button>
          <h1 style={{ fontSize: 22, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>
            {plans.some((p) => p.id === editingPlan.id) ? "Editar Plan" : "Nuevo Plan"}
          </h1>
        </div>

        <div style={{ marginBottom: 20 }}>
          <div style={{ fontSize: 12, color: C.textDim, marginBottom: 6, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1 }}>Nombre</div>
          <input type="text" placeholder="Ej: Push Day, Torso, Pierna..." value={editingPlan.name}
            onChange={(e) => setEditingPlan((p) => ({ ...p, name: e.target.value }))}
            style={{
              width: "100%", padding: "14px 16px", borderRadius: 12, border: `1px solid ${C.border}`,
              background: C.card, color: C.text, fontSize: 15, outline: "none",
              boxSizing: "border-box", fontFamily: fontBody,
            }} />
        </div>

        <div style={{ fontSize: 12, color: C.textDim, marginBottom: 10, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1 }}>
          Ejercicios ({editingPlan.exercises.length})
        </div>

        {editingPlan.exercises.map((ex, idx) => {
          const info = getExerciseInfo(ex.exerciseId);
          if (!info) return null;
          return (
            <div key={idx} style={{ ...baseCard, marginBottom: 8, padding: "12px 14px" }}>
              <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}>
                <span style={{ fontSize: 20 }}>{info.emoji}</span>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 14, fontWeight: 600, color: C.text }}>{info.name}</div>
                  <div style={{ fontSize: 12, color: C.textDim }}>{info.group} Â· {TYPE_TAGS[info.type || "s"]}</div>
                </div>
                <button onClick={() => removeExerciseFromPlan(idx)} style={{
                  background: "none", border: "none", color: C.danger, fontSize: 16, cursor: "pointer", padding: "4px 8px",
                }}>âœ•</button>
              </div>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                  <button onClick={() => updatePlanSets(idx, -1)} style={{
                    width: 28, height: 28, borderRadius: 7, border: `1px solid ${C.border}`,
                    background: "transparent", color: C.text, fontSize: 14, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center",
                  }}>âˆ’</button>
                  <span style={{ fontSize: 15, fontWeight: 700, color: C.accent, minWidth: 20, textAlign: "center" }}>{ex.numSets}</span>
                  <button onClick={() => updatePlanSets(idx, 1)} style={{
                    width: 28, height: 28, borderRadius: 7, border: `1px solid ${C.border}`,
                    background: "transparent", color: C.text, fontSize: 14, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center",
                  }}>+</button>
                  <span style={{ fontSize: 11, color: C.textDim, marginLeft: 2 }}>series</span>
                </div>
                <div style={{ width: 1, height: 20, background: C.border }} />
                <input type="number" inputMode="numeric" placeholder="reps" value={ex.reps || ""}
                  onChange={(e) => updatePlanExercise(idx, "reps", e.target.value)}
                  onFocus={(e) => e.target.select()}
                  style={{ width: 52, padding: "6px 4px", borderRadius: 8, border: `1px solid ${C.border}`, background: "rgba(255,255,255,0.04)", color: C.text, fontSize: 14, fontWeight: 600, textAlign: "center", outline: "none", boxSizing: "border-box" }} />
                <span style={{ fontSize: 11, color: C.textDim }}>Ã—</span>
                <input type="number" inputMode="decimal" placeholder="kg" value={ex.weight || ""}
                  onChange={(e) => updatePlanExercise(idx, "weight", e.target.value)}
                  onFocus={(e) => e.target.select()}
                  style={{ width: 58, padding: "6px 4px", borderRadius: 8, border: `1px solid ${C.border}`, background: "rgba(255,255,255,0.04)", color: C.text, fontSize: 14, fontWeight: 600, textAlign: "center", outline: "none", boxSizing: "border-box" }} />
                <span style={{ fontSize: 11, color: C.textDim }}>kg</span>
              </div>
            </div>
          );
        })}

        <button onClick={() => setView("picker")} style={{
          width: "100%", padding: "14px", borderRadius: 14, border: `2px dashed ${C.accent}40`,
          background: C.accentDim, color: C.accent, fontSize: 14, fontWeight: 600, cursor: "pointer", marginTop: 4, marginBottom: 20,
        }}>+ AÃ±adir Ejercicio</button>

        <button onClick={savePlan} style={{
          width: "100%", padding: "16px", borderRadius: 14, border: "none",
          background: `linear-gradient(135deg, ${C.accent}, #ff8f35)`, color: "#fff",
          fontSize: 15, fontWeight: 700, cursor: "pointer", fontFamily: font,
          boxShadow: `0 4px 24px ${C.accentGlow}`, marginBottom: 10,
        }}>Guardar Plan</button>
      </div>
    );
  };

  // â•â•â• ACTIVE WORKOUT â•â•â•
  const renderActiveWorkout = () => (
    <div style={{ padding: "0 20px 100px" }}>
      <div style={{ paddingTop: 16, marginBottom: 20, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <h1 style={{ fontSize: 22, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>Entrenamiento</h1>
        <button onClick={finishWorkout} style={{
          padding: "10px 20px", borderRadius: 12, border: "none", background: C.success,
          color: "#000", fontSize: 14, fontWeight: 700, cursor: "pointer",
        }}>Finalizar âœ“</button>
      </div>

      {activeWorkout?.exercises.map((ex, exIdx) => {
        const info = getExerciseInfo(ex.exerciseId);
        const t = info?.type || "s";
        const prevBest = getPreviousBest(ex.exerciseId);
        return (
          <div key={exIdx} style={{ ...baseCard, marginBottom: 14 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 14 }}>
              <span style={{ fontSize: 22 }}>{info?.emoji || "â­"}</span>
              <div>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <span style={{ fontSize: 16, fontWeight: 700, color: C.accent }}>{info?.name || ex.exerciseId}</span>
                  <span style={{ fontSize: 10, padding: "2px 6px", borderRadius: 6, background: "rgba(255,255,255,0.06)", color: C.textDim }}>{TYPE_TAGS[t]}</span>
                </div>
                {prevBest && (
                  <div style={{ fontSize: 11, color: C.textDim }}>
                    Anterior: {prevBest.map((s) => formatSetShort(s, t)).join(", ")}
                  </div>
                )}
              </div>
            </div>
            {renderSetHeader(t)}
            {ex.sets.map((set, setIdx) => renderSetRow(ex, exIdx, set, setIdx))}
            <button onClick={() => addSet(exIdx)} style={{
              width: "100%", padding: "10px", borderRadius: 10, border: `1px dashed ${C.border}`,
              background: "transparent", color: C.textDim, fontSize: 13, cursor: "pointer", marginTop: 8,
            }}>+ AÃ±adir Serie</button>
          </div>
        );
      })}

      <button onClick={() => setView("picker")} style={{
        width: "100%", padding: "16px", borderRadius: 14, border: `2px dashed ${C.accent}40`,
        background: C.accentDim, color: C.accent, fontSize: 15, fontWeight: 600, cursor: "pointer", marginTop: 4,
      }}>+ AÃ±adir Ejercicio</button>
    </div>
  );

  // â•â•â• EXPORT â•â•â•
  const [exportData, setExportData] = useState(null);
  const [exportType, setExportType] = useState("");

  const exportJSON = () => {
    const data = filteredWorkouts.map((w) => ({
      date: w.date,
      exercises: w.exercises.map((ex) => {
        const info = getExerciseInfo(ex.exerciseId);
        return {
          id: ex.exerciseId, name: info?.name || ex.exerciseId,
          group: info?.group || "?", type: info?.type || "s",
          sets: ex.sets,
        };
      }),
    }));
    setExportData(JSON.stringify(data, null, 2));
    setExportType("JSON");
  };

  const exportCSV = () => {
    const rows = [["Fecha", "Ejercicio", "Grupo", "Tipo", "Serie", "Peso (kg)", "Reps", "Segundos", "Distancia (km)", "Pulsaciones"]];
    filteredWorkouts.forEach((w) => {
      const date = new Date(w.date).toLocaleDateString("es-ES");
      w.exercises.forEach((ex) => {
        const info = getExerciseInfo(ex.exerciseId);
        const t = info?.type || "s";
        ex.sets.forEach((s, i) => {
          rows.push([
            date, info?.name || ex.exerciseId, info?.group || "", t,
            i + 1,
            t === "s" ? (s.weight || "") : "",
            t !== "t" && t !== "c" ? (s.reps || "") : "",
            t === "t" ? (s.seconds || "") : "",
            t === "t" ? (s.distance || "") : "",
            t === "t" || t === "c" ? (s.heartRate || "") : "",
            t === "c" ? (s.minutes || "") : "",
          ]);
        });
      });
    });
    setExportData(rows.map((r) => r.map((v) => `"${v}"`).join(",")).join("\n"));
    setExportType("CSV");
  };

  const selectAllExport = () => {
    const el = document.getElementById("export-textarea");
    if (el) { el.select(); el.setSelectionRange(0, 99999); }
  };

  // â•â•â• HISTORY â•â•â•
  const [historyFilter, setHistoryFilter] = useState("all");
  const historyFilters = [
    { id: "all", label: "Todo" },
    { id: "1w", label: "1S" },
    { id: "1m", label: "1M" },
    { id: "3m", label: "3M" },
    { id: "6m", label: "6M" },
    { id: "1y", label: "1A" },
  ];

  const filteredWorkouts = useMemo(() => {
    const list = historyFilter === "all" ? workouts : (() => {
      const now = new Date();
      const ms = { "1w": 7, "1m": 30, "3m": 90, "6m": 180, "1y": 365 };
      const cutoff = new Date(now.getTime() - (ms[historyFilter] || 0) * 86400000);
      return workouts.filter((w) => new Date(w.date) >= cutoff);
    })();
    return [...list].sort((a, b) => new Date(b.date) - new Date(a.date));
  }, [workouts, historyFilter]);
  const renderHistory = () => (
    <div style={{ padding: "0 20px 100px" }}>
      <div style={{ paddingTop: 16, marginBottom: 14, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <button onClick={() => setView("home")} style={{ background: "none", border: "none", color: C.accent, fontSize: 28, cursor: "pointer", padding: 0 }}>â€¹</button>
          <h1 style={{ fontSize: 24, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>Historial</h1>
        </div>
        {filteredWorkouts.length > 0 && (
          <div style={{ display: "flex", gap: 6 }}>
            <button onClick={exportJSON} style={{
              padding: "6px 12px", borderRadius: 8, border: `1px solid ${C.border}`,
              background: C.card, color: C.textDim, fontSize: 12, fontWeight: 600, cursor: "pointer",
            }}>JSON</button>
            <button onClick={exportCSV} style={{
              padding: "6px 12px", borderRadius: 8, border: `1px solid ${C.border}`,
              background: C.card, color: C.textDim, fontSize: 12, fontWeight: 600, cursor: "pointer",
            }}>CSV</button>
          </div>
        )}
      </div>

      {/* Time filter */}
      {workouts.length > 0 && (
        <div style={{ display: "flex", gap: 0, marginBottom: 18, borderRadius: 10, overflow: "hidden", border: `1px solid ${C.border}` }}>
          {historyFilters.map((f) => (
            <button key={f.id} onClick={() => setHistoryFilter(f.id)} style={{
              flex: 1, padding: "8px 0", border: "none", fontSize: 12, fontWeight: 700, cursor: "pointer",
              background: historyFilter === f.id ? C.accentDim : C.card,
              color: historyFilter === f.id ? C.accent : C.textDim,
            }}>{f.label}</button>
          ))}
        </div>
      )}

      {filteredWorkouts.length > 0 && (
        <p style={{ fontSize: 12, color: C.textDim, margin: "0 0 14px" }}>
          {filteredWorkouts.length} sesiÃ³n{filteredWorkouts.length !== 1 ? "es" : ""}
        </p>
      )}
      {filteredWorkouts.length === 0 ? (
        <div style={{ ...baseCard, textAlign: "center", padding: "40px 20px", color: C.textDim }}>
          <p>{workouts.length === 0 ? "Sin sesiones todavÃ­a" : "Sin sesiones en este periodo"}</p>
        </div>
      ) : filteredWorkouts.map((w) => {
        const vol = totalVolume(w);
        return (
          <div key={w.id} onClick={() => { setSelectedWorkout(w); setPrevView("history"); setView("detail"); }}
            style={{ ...baseCard, marginBottom: 10, cursor: "pointer" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: 8 }}>
              <div>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  <span style={{ fontSize: 15, fontWeight: 600, color: C.text }}>{formatDate(w.date)}</span>
                  {w.circuit && <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 6, background: "rgba(168,85,247,0.15)", color: "#a855f7", fontWeight: 700 }}>CIRCUITO</span>}
                </div>
                <div style={{ fontSize: 12, color: C.textDim, marginTop: 2 }}>
                  {w.circuit ? `${w.circuit.rounds} rondas Â· ${w.circuit.workTime}s/${w.circuit.restTime}s` : `${totalSets(w)} series`}
                </div>
              </div>
              {!w.circuit && vol > 0 && <div style={{ fontSize: 14, fontWeight: 700, color: C.accent }}>{(vol / 1000).toFixed(1)}k kg</div>}
            </div>
            <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
              {w.exercises.map((ex, i) => {
                const info = getExerciseInfo(ex.exerciseId);
                return <span key={i} style={{ padding: "4px 10px", borderRadius: 8, background: "rgba(255,255,255,0.05)", color: C.textDim, fontSize: 12 }}>
                  {info?.emoji || "â­"} {info?.name || ex.exerciseId}
                </span>;
              })}
            </div>
          </div>
        );
      })}
    </div>
  );

  // â•â•â• DETAIL â•â•â•
  const renderDetail = () => {
    if (!selectedWorkout) return null;
    const isEditing = !!editingWorkout;
    const w = isEditing ? editingWorkout : selectedWorkout;
    const vol = totalVolume(w);
    return (
      <div style={{ padding: "0 20px 100px" }}>
        <div style={{ paddingTop: 16, marginBottom: 20, display: "flex", alignItems: "center", gap: 12 }}>
          <button onClick={() => {
            if (isEditing) { cancelEditing(); } else { setSelectedWorkout(null); setView(prevView); }
          }} style={{ background: "none", border: "none", color: C.accent, fontSize: 28, cursor: "pointer", padding: 0 }}>â€¹</button>
          <div style={{ flex: 1 }}>
            {isEditing ? (
              <input type="date"
                value={new Date(w.date).toISOString().slice(0, 10)}
                onChange={(e) => {
                  const d = new Date(e.target.value);
                  d.setHours(12);
                  setEditingWorkout((prev) => ({ ...prev, date: d.toISOString() }));
                }}
                style={{
                  background: "rgba(255,255,255,0.06)", border: `1px solid ${C.accent}`,
                  borderRadius: 10, padding: "8px 12px", color: C.text, fontSize: 16,
                  fontWeight: 700, fontFamily: font, outline: "none", width: "100%", boxSizing: "border-box",
                  colorScheme: "dark",
                }} />
            ) : (
              <h1 style={{ fontSize: 20, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>{formatFullDate(w.date)}</h1>
            )}
            <p style={{ margin: "2px 0 0", fontSize: 13, color: C.textDim }}>
              {w.circuit ? `${w.circuit.rounds} rondas Â· ${w.circuit.workTime}s/${w.circuit.restTime}s` : `${totalSets(w)} series${vol > 0 ? ` Â· ${(vol / 1000).toFixed(1)}k kg` : ""}`}
              {isEditing && <span style={{ color: C.accent, marginLeft: 8 }}>Â· editando</span>}
            </p>
          </div>
          {!isEditing ? (
            <button onClick={startEditing} style={{
              padding: "8px 16px", borderRadius: 10, border: `1px solid ${C.accent}`,
              background: C.accentDim, color: C.accent, fontSize: 13, fontWeight: 600, cursor: "pointer",
            }}>âœï¸ Editar</button>
          ) : (
            <button onClick={saveEditing} style={{
              padding: "8px 16px", borderRadius: 10, border: "none",
              background: C.success, color: "#000", fontSize: 13, fontWeight: 700, cursor: "pointer",
            }}>Guardar âœ“</button>
          )}
        </div>

        {w.circuit && !isEditing && (
          <div style={{ ...baseCard, marginBottom: 14, background: "rgba(168,85,247,0.08)", borderColor: "rgba(168,85,247,0.3)" }}>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8, textAlign: "center" }}>
              <div><div style={{ fontSize: 20, fontWeight: 700, color: C.text, fontFamily: font }}>{w.circuit.rounds}</div><div style={{ fontSize: 11, color: C.textDim }}>Rondas</div></div>
              <div><div style={{ fontSize: 20, fontWeight: 700, color: C.text, fontFamily: font }}>{w.circuit.workTime}s</div><div style={{ fontSize: 11, color: C.textDim }}>Trabajo</div></div>
              <div><div style={{ fontSize: 20, fontWeight: 700, color: C.text, fontFamily: font }}>{w.circuit.restTime}s</div><div style={{ fontSize: 11, color: C.textDim }}>Descanso</div></div>
            </div>
          </div>
        )}

        {w.exercises.map((ex, exIdx) => {
          const info = getExerciseInfo(ex.exerciseId);
          const t = info?.type || "s";
          return (
            <div key={exIdx} style={{ ...baseCard, marginBottom: 12 }}>
              <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                  <span style={{ fontSize: 20 }}>{info?.emoji || "â­"}</span>
                  <div>
                    <span style={{ fontSize: 15, fontWeight: 700, color: C.accent }}>{info?.name || ex.exerciseId}</span>
                    {isEditing && <span style={{ fontSize: 10, padding: "2px 6px", borderRadius: 6, background: "rgba(255,255,255,0.06)", color: C.textDim, marginLeft: 8 }}>{TYPE_TAGS[t]}</span>}
                  </div>
                </div>
                {!isEditing ? (
                  <button onClick={(e) => { e.stopPropagation(); setProgressExercise(ex.exerciseId); setView("progress"); }}
                    style={{ background: C.accentDim, border: "none", color: C.accent, fontSize: 12, padding: "6px 12px", borderRadius: 8, cursor: "pointer", fontWeight: 600 }}>
                    ğŸ“ˆ Progreso
                  </button>
                ) : (
                  <button onClick={() => removeExercise(exIdx)}
                    style={{ background: C.dangerDim, border: "none", color: C.danger, fontSize: 12, padding: "6px 12px", borderRadius: 8, cursor: "pointer", fontWeight: 600 }}>
                    Quitar
                  </button>
                )}
              </div>

              {isEditing ? (
                <>
                  {renderSetHeader(t)}
                  {ex.sets.map((set, setIdx) => renderSetRow(ex, exIdx, set, setIdx))}
                  <button onClick={() => addSet(exIdx)} style={{
                    width: "100%", padding: "10px", borderRadius: 10, border: `1px dashed ${C.border}`,
                    background: "transparent", color: C.textDim, fontSize: 13, cursor: "pointer", marginTop: 8,
                  }}>+ AÃ±adir Serie</button>
                </>
              ) : (
                ex.sets.map((s, j) => (
                  <div key={j} style={{ display: "flex", gap: 16, padding: "8px 12px", background: "rgba(255,255,255,0.03)", borderRadius: 8, marginBottom: 4, alignItems: "center" }}>
                    <span style={{ fontSize: 12, color: C.textDim, width: 30 }}>#{j + 1}</span>
                    <span style={{ fontSize: 15, fontWeight: 600, color: C.text }}>{formatSetDetail(s, t)}</span>
                  </div>
                ))
              )}
            </div>
          );
        })}

        {isEditing && (
          <button onClick={() => setView("picker")} style={{
            width: "100%", padding: "16px", borderRadius: 14, border: `2px dashed ${C.accent}40`,
            background: C.accentDim, color: C.accent, fontSize: 15, fontWeight: 600, cursor: "pointer", marginTop: 4, marginBottom: 12,
          }}>+ AÃ±adir Ejercicio</button>
        )}

        <button onClick={() => deleteWorkout(w.id)} style={{
          width: "100%", padding: "14px", borderRadius: 12, border: `1px solid ${C.danger}40`,
          background: C.dangerDim, color: C.danger, fontSize: 14, fontWeight: 600, cursor: "pointer", marginTop: isEditing ? 0 : 4,
        }}>Eliminar sesiÃ³n</button>

        {!isEditing && (
          <>
            <button onClick={() => { saveWorkoutAsPlan(w); alert("Plan guardado"); }} style={{
              width: "100%", padding: "14px", borderRadius: 12, border: `1px solid ${C.border}`,
              background: C.card, color: C.textDim, fontSize: 14, fontWeight: 600, cursor: "pointer", marginTop: 8,
            }}>ğŸ“‹ Guardar como plan</button>
            <button onClick={() => {
              const lines = [`Entrenamiento Â· ${formatFullDate(w.date)}`];
              if (w.circuit) lines.push(`Circuito: ${w.circuit.rounds}R Â· ${w.circuit.workTime}s/${w.circuit.restTime}s`);
              else lines.push(`${totalSets(w)} series${vol > 0 ? ` Â· ${(vol / 1000).toFixed(1)}k kg` : ""}`);
              lines.push("");
              w.exercises.forEach((ex) => {
                const info = getExerciseInfo(ex.exerciseId);
                const t = info?.type || "s";
                lines.push(`${info?.emoji || ""} ${info?.name || ex.exerciseId}`);
                ex.sets.forEach((s, j) => lines.push(`  #${j + 1} ${formatSetShort(s, t)}`));
                lines.push("");
              });
              setExportData(lines.join("\n").trim());
              setExportType("Entrenamiento");
            }} style={{
              width: "100%", padding: "14px", borderRadius: 12, border: `1px solid ${C.border}`,
              background: C.card, color: C.textDim, fontSize: 14, fontWeight: 600, cursor: "pointer", marginTop: 8,
            }}>ğŸ“¤ Compartir</button>
          </>
        )}
      </div>
    );
  };

  // â•â•â• PROGRESS â•â•â•
  const renderProgress = () => {
    const data = getProgression(progressExercise);
    const info = getExerciseInfo(progressExercise);
    const t = info?.type || "s";

    const charts = t === "t"
      ? [{ label: "MEJOR TIEMPO", key: "seconds", color: C.accent, fmt: (v) => fmtSec(v) }, ...(data.some((d) => d.distance) ? [{ label: "DISTANCIA (km)", key: "distance", color: C.success }] : [])]
      : t === "c"
      ? [{ label: "DURACIÃ“N (min)", key: "minutes", color: C.accent }, ...(data.some((d) => d.heartRate) ? [{ label: "PULSACIONES (bpm)", key: "heartRate", color: C.success }] : [])]
      : t === "b"
      ? [{ label: "MÃXIMAS REPS", key: "reps", color: C.accent }]
      : [
          { label: "PESO MÃXIMO (kg)", key: "weight", color: C.accent },
          { label: "VOLUMEN MEJOR SERIE (kg)", key: "volume", color: C.success },
        ];

    return (
      <div style={{ padding: "0 20px 100px" }}>
        <div style={{ paddingTop: 16, marginBottom: 20, display: "flex", alignItems: "center", gap: 12 }}>
          <button onClick={() => { setProgressExercise(null); setView("detail"); }}
            style={{ background: "none", border: "none", color: C.accent, fontSize: 28, cursor: "pointer", padding: 0 }}>â€¹</button>
          <div>
            <h1 style={{ fontSize: 20, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>
              {info?.emoji || "â­"} {info?.name || progressExercise}
            </h1>
            <p style={{ margin: "2px 0 0", fontSize: 13, color: C.textDim }}>ProgresiÃ³n</p>
          </div>
        </div>
        {data.length === 0 ? (
          <div style={{ ...baseCard, textAlign: "center", padding: "40px 20px", color: C.textDim }}>No hay datos de progresiÃ³n aÃºn</div>
        ) : (
          <>
            {charts.map((chart) => {
              const maxVal = Math.max(...data.map((d) => d[chart.key] || 0), 0);
              return (
                <div key={chart.key} style={{ ...baseCard, marginBottom: 14 }}>
                  <div style={{ fontSize: 13, color: C.textDim, marginBottom: 12, fontWeight: 600 }}>{chart.label}</div>
                  <div style={{ display: "flex", alignItems: "end", gap: 4, height: 120 }}>
                    {data.slice(-12).map((d, i) => (
                      <div key={i} style={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", gap: 4 }}>
                        <span style={{ fontSize: 10, color: C.textDim }}>{chart.fmt ? chart.fmt(d[chart.key]) : d[chart.key]}</span>
                        <div style={{
                          width: "100%", height: `${maxVal ? ((d[chart.key] || 0) / maxVal) * 80 : 0}px`,
                          background: `linear-gradient(to top, ${chart.color}, ${chart.color}90)`,
                          borderRadius: "6px 6px 2px 2px", minHeight: 4,
                        }} />
                        <span style={{ fontSize: 9, color: C.textDim }}>
                          {new Date(d.date).toLocaleDateString("es-ES", { day: "numeric", month: "short" })}
                        </span>
                      </div>
                    ))}
                  </div>
                </div>
              );
            })}
            <div style={{ ...baseCard }}>
              <div style={{ fontSize: 13, color: C.textDim, marginBottom: 12, fontWeight: 600 }}>HISTORIAL</div>
              {data.map((d, i) => (
                <div key={i} style={{ display: "flex", justifyContent: "space-between", padding: "10px 0", borderBottom: i < data.length - 1 ? `1px solid ${C.border}` : "none" }}>
                  <span style={{ fontSize: 13, color: C.textDim }}>{formatDate(d.date)}</span>
                  <span style={{ fontSize: 14, fontWeight: 600, color: C.text }}>
                    {t === "t" ? (fmtSec(d.seconds) + (d.distance ? ` Â· ${d.distance}km` : "")) : t === "c" ? (`${d.minutes} min` + (d.heartRate ? ` Â· ${d.heartRate} bpm` : "")) : t === "b" ? `${d.reps} reps` : `${d.weight} kg Ã— ${d.reps}`}
                  </span>
                </div>
              ))}
            </div>
          </>
        )}
      </div>
    );
  };

  // â•â•â• EXERCISES LIST â•â•â•
  const renderExercises = () => (
    <div style={{ padding: "0 20px 100px" }}>
      <div style={{ paddingTop: 16, marginBottom: 24 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <button onClick={() => setView("home")} style={{ background: "none", border: "none", color: C.accent, fontSize: 28, cursor: "pointer", padding: 0 }}>â€¹</button>
          <div>
            <h1 style={{ fontSize: 24, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>Ejercicios</h1>
            <p style={{ fontSize: 13, color: C.textDim, marginTop: 4 }}>{ALL_EXERCISES.length} ejercicios disponibles</p>
          </div>
        </div>
      </div>
      {Object.entries(EXERCISES).map(([group, exs]) => (
        <div key={group} style={{ marginBottom: 20 }}>
          <h3 style={{ fontSize: 14, fontWeight: 700, color: C.accent, marginBottom: 10, textTransform: "uppercase", letterSpacing: 1 }}>{group} ({exs.length})</h3>
          {exs.map((ex) => {
            const prog = getProgression(ex.id);
            const isCustom = ex.id.startsWith("custom_");
            const t = ex.type || "s";
            return (
              <div key={ex.id} style={{
                ...baseCard, marginBottom: 6, padding: "12px 16px", display: "flex",
                justifyContent: "space-between", alignItems: "center",
                cursor: prog.length > 0 ? "pointer" : "default", opacity: prog.length > 0 ? 1 : 0.6,
              }} onClick={() => { if (prog.length > 0) { setProgressExercise(ex.id); setPrevView("exercises"); setView("progress"); } }}>
                <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                  <span style={{ fontSize: 20 }}>{ex.emoji}</span>
                  <div>
                    <span style={{ fontSize: 14, fontWeight: 600, color: C.text }}>{ex.name}</span>
                    <div style={{ fontSize: 10, color: C.textDim, marginTop: 2 }}>
                      {TYPE_TAGS[t]}{isCustom && <span style={{ color: C.accent, marginLeft: 6 }}>personalizado</span>}
                    </div>
                  </div>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                  {prog.length > 0 && (
                    <span style={{ fontSize: 13, color: C.textDim }}>
                      {t === "t" ? (fmtSec(prog[prog.length - 1].seconds) + (prog[prog.length - 1].distance ? ` Â· ${prog[prog.length - 1].distance}km` : "")) : t === "c" ? (`${prog[prog.length - 1].minutes} min` + (prog[prog.length - 1].heartRate ? ` Â· ${prog[prog.length - 1].heartRate} bpm` : "")) : t === "b" ? `${prog[prog.length - 1].reps} reps` : `${prog[prog.length - 1].weight} kg`} Â· {prog.length}Ã—
                    </span>
                  )}
                  {isCustom && (
                    <button onClick={(e) => { e.stopPropagation(); deleteCustomExercise(ex.id); }}
                      style={{ background: "none", border: "none", color: C.danger, fontSize: 14, cursor: "pointer", padding: "2px 6px" }}>âœ•</button>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      ))}
    </div>
  );

  // â•â•â• NUTRITION LOGIC â•â•â•
  const getDayLog = (date) => nutritionLog[date] || { meals: [], basalCal: nutSettings.basalCal, activityCal: 0 };
  const todayLog = getDayLog(nutDate);

  const dayTotals = useMemo(() => {
    const log = getDayLog(nutDate);
    const cal = log.meals.reduce((s, m) => s + (m.cal || 0), 0);
    const prot = log.meals.reduce((s, m) => s + (m.prot || 0), 0);
    const balance = cal - log.basalCal - log.activityCal;
    return { cal, prot, basalCal: log.basalCal, activityCal: log.activityCal, balance };
  }, [nutritionLog, nutDate, nutSettings]);

  const updateDayField = (field, value) => {
    setNutritionLog((prev) => ({
      ...prev,
      [nutDate]: { ...getDayLog(nutDate), [field]: Number(value) || 0 },
    }));
  };

  const addMealFromDB = () => {
    if (!nutSelectedFood || !nutGrams) return;
    const f = nutSelectedFood;
    const g = Number(nutGrams);
    const meal = { id: Date.now(), name: f.name, grams: g, cal: Math.round(f.cal * g / 100), prot: Math.round(f.prot * g / 100 * 10) / 10, fromDB: true };
    setNutritionLog((prev) => {
      const day = getDayLog(nutDate);
      return { ...prev, [nutDate]: { ...day, meals: [...day.meals, meal] } };
    });
    setNutSelectedFood(null); setNutGrams("100"); setNutView("summary");
  };

  const addManualMeal = () => {
    if (!nutManualCal) return;
    const meal = { id: Date.now(), name: nutManualName || "Manual", grams: null, cal: Number(nutManualCal) || 0, prot: Number(nutManualProt) || 0, fromDB: false };
    setNutritionLog((prev) => {
      const day = getDayLog(nutDate);
      return { ...prev, [nutDate]: { ...day, meals: [...day.meals, meal] } };
    });
    setNutManualName(""); setNutManualCal(""); setNutManualProt(""); setNutView("summary");
  };

  const removeMeal = (mealId) => {
    setNutritionLog((prev) => {
      const day = getDayLog(nutDate);
      return { ...prev, [nutDate]: { ...day, meals: day.meals.filter((m) => m.id !== mealId) } };
    });
  };

  const saveMealEdit = (mealId, updates) => {
    setNutritionLog((prev) => {
      const day = getDayLog(nutDate);
      return { ...prev, [nutDate]: { ...day, meals: day.meals.map((m) => m.id === mealId ? { ...m, ...updates } : m) } };
    });
    setNutEditingMeal(null);
  };

  const getFilteredNutLog = () => {
    if (nutExportFilter === "all") return nutritionLog;
    const now = new Date();
    const ms = { "1w": 7, "1m": 30, "3m": 90, "6m": 180, "1y": 365 };
    const cutoff = new Date(now.getTime() - (ms[nutExportFilter] || 0) * 86400000).toISOString().slice(0, 10);
    const filtered = {};
    Object.entries(nutritionLog).forEach(([date, day]) => { if (date >= cutoff) filtered[date] = day; });
    return filtered;
  };

  const exportNutJSON = () => {
    const log = getFilteredNutLog();
    const filteredWeight = nutExportFilter === "all" ? weightLog : (() => {
      const now = new Date();
      const ms = { "1w": 7, "1m": 30, "3m": 90, "6m": 180, "1y": 365 };
      const cutoff = new Date(now.getTime() - (ms[nutExportFilter] || 0) * 86400000).toISOString().slice(0, 10);
      return weightLog.filter((w) => w.date >= cutoff);
    })();
    const data = { nutrition: log, weight: filteredWeight, settings: nutSettings };
    setExportData(JSON.stringify(data, null, 2));
    setExportType("JSON NutriciÃ³n");
  };

  const exportNutCSV = () => {
    const log = getFilteredNutLog();
    const rows = [["Fecha", "Alimento", "Gramos", "CalorÃ­as", "ProteÃ­nas", "Basal", "Actividad", "Balance"]];
    Object.entries(log).sort(([a], [b]) => a.localeCompare(b)).forEach(([date, day]) => {
      const totalCal = day.meals.reduce((s, m) => s + (m.cal || 0), 0);
      const balance = totalCal - (day.basalCal || 0) - (day.activityCal || 0);
      if (day.meals.length === 0) {
        rows.push([date, "", "", 0, 0, day.basalCal || 0, day.activityCal || 0, balance]);
      } else {
        day.meals.forEach((m, i) => {
          rows.push([date, m.name, m.grams || "", m.cal, m.prot, i === 0 ? (day.basalCal || 0) : "", i === 0 ? (day.activityCal || 0) : "", i === 0 ? balance : ""]);
        });
      }
    });
    setExportData(rows.map((r) => r.map((v) => `"${v}"`).join(",")).join("\n"));
    setExportType("CSV NutriciÃ³n");
  };

  const addWeight = () => {
    if (!nutNewWeight) return;
    const entry = { date: nutDate, weight: Number(nutNewWeight) };
    setWeightLog((prev) => {
      const filtered = prev.filter((w) => w.date !== nutDate);
      return [...filtered, entry].sort((a, b) => a.date.localeCompare(b.date));
    });
    setNutNewWeight(""); setNutView("summary");
  };

  const changeNutDate = (delta) => {
    const d = new Date(nutDate);
    d.setDate(d.getDate() + delta);
    setNutDate(d.toISOString().slice(0, 10));
    setNutEditingMeal(null);
  };

  const latestWeight = weightLog.length > 0 ? weightLog[weightLog.length - 1] : null;

  const nutChartData = useMemo(() => {
    const ms = { "1w": 7, "1m": 30, "3m": 90, "6m": 180, "1y": 365 };
    const days = ms[nutChartFilter] || 30;
    const now = new Date();
    const data = [];
    for (let i = days - 1; i >= 0; i--) {
      const d = new Date(now); d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      const log = nutritionLog[key];
      const wEntry = weightLog.find((w) => w.date === key);
      const ingeridas = log ? log.meals.reduce((s, m) => s + (m.cal || 0), 0) : null;
      const quemadas = log ? (log.basalCal || 0) + (log.activityCal || 0) : null;
      data.push({
        date: d.toLocaleDateString("es-ES", { day: "numeric", month: "short" }),
        ingeridas: ingeridas || undefined,
        quemadas: quemadas || undefined,
        peso: wEntry ? wEntry.weight : undefined,
      });
    }
    return data;
  }, [nutritionLog, weightLog, nutChartFilter]);

  // â•â•â• NUTRITION VIEW â•â•â•
  const renderNutrition = () => {
    const green = "#4ade80";
    const red = "#f87171";

    // â”€â”€ Summary â”€â”€
    if (nutView === "summary") {
      const balanceColor = dayTotals.balance > 0 ? green : dayTotals.balance < 0 ? red : C.textDim;
      const protPct = nutSettings.protTarget > 0 ? Math.round(dayTotals.prot / nutSettings.protTarget * 100) : 0;
      const dateLabel = nutDate === new Date().toISOString().slice(0, 10) ? "Hoy" :
        new Date(nutDate + "T12:00").toLocaleDateString("es-ES", { weekday: "short", day: "numeric", month: "short" });

      return (
        <div style={{ padding: "0 20px 100px" }}>
          {/* Date nav */}
          <div style={{ paddingTop: 16, marginBottom: 16, display: "flex", alignItems: "center", justifyContent: "space-between" }}>
            <button onClick={() => changeNutDate(-1)} style={{ background: "none", border: "none", color: C.accent, fontSize: 24, cursor: "pointer", padding: "4px 12px" }}>â€¹</button>
            <div style={{ textAlign: "center" }}>
              <div style={{ fontSize: 20, fontWeight: 700, color: C.text, fontFamily: font }}>{dateLabel}</div>
              {latestWeight && <div style={{ fontSize: 12, color: C.textDim, marginTop: 2 }}>Peso: {latestWeight.weight} kg</div>}
            </div>
            <button onClick={() => changeNutDate(1)} style={{ background: "none", border: "none", color: C.accent, fontSize: 24, cursor: "pointer", padding: "4px 12px" }}>â€º</button>
          </div>

          {/* Balance card */}
          <div style={{ ...baseCard, marginBottom: 14, padding: "16px" }}>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 14 }}>
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 28, fontWeight: 800, color: C.accent, fontFamily: font }}>{dayTotals.cal}</div>
                <div style={{ fontSize: 11, color: C.textDim }}>kcal ingeridas</div>
              </div>
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 28, fontWeight: 800, color: "#a78bfa", fontFamily: font }}>{parseFloat(dayTotals.prot.toFixed(1))}g</div>
                <div style={{ fontSize: 11, color: C.textDim }}>proteÃ­na {protPct > 0 ? `(${protPct}%)` : ""}</div>
              </div>
            </div>
            {/* Protein bar */}
            {nutSettings.protTarget > 0 && (
              <div style={{ height: 6, borderRadius: 3, background: "rgba(255,255,255,0.06)", marginBottom: 14, overflow: "hidden" }}>
                <div style={{ height: "100%", borderRadius: 3, width: `${Math.min(protPct, 100)}%`, background: "#a78bfa", transition: "width 0.3s" }} />
              </div>
            )}
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8, fontSize: 12, textAlign: "center" }}>
              <div>
                <div style={{ fontWeight: 700, color: C.text }}>{dayTotals.basalCal}</div>
                <div style={{ color: C.textDim }}>Basal</div>
              </div>
              <div>
                <div style={{ fontWeight: 700, color: C.text }}>{dayTotals.activityCal}</div>
                <div style={{ color: C.textDim }}>Actividad</div>
              </div>
              <div>
                <div style={{ fontWeight: 700, color: balanceColor }}>{dayTotals.balance > 0 ? "+" : ""}{dayTotals.balance}</div>
                <div style={{ color: C.textDim }}>Balance</div>
              </div>
            </div>
          </div>

          {/* Editable basal + activity */}
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 14 }}>
            <div style={{ ...baseCard, padding: "10px 12px" }}>
              <div style={{ fontSize: 11, color: C.textDim, marginBottom: 4 }}>Basal (kcal)</div>
              <input type="number" value={todayLog.basalCal} onChange={(e) => updateDayField("basalCal", e.target.value)}
                style={{ width: "100%", background: "transparent", border: "none", color: C.text, fontSize: 16, fontWeight: 700, outline: "none", fontFamily: font, boxSizing: "border-box" }} />
            </div>
            <div style={{ ...baseCard, padding: "10px 12px" }}>
              <div style={{ fontSize: 11, color: C.textDim, marginBottom: 4 }}>Actividad (kcal)</div>
              <input type="number" value={todayLog.activityCal} onChange={(e) => updateDayField("activityCal", e.target.value)}
                style={{ width: "100%", background: "transparent", border: "none", color: C.text, fontSize: 16, fontWeight: 700, outline: "none", fontFamily: font, boxSizing: "border-box" }} />
            </div>
          </div>

          {/* Chart toggle */}
          <button onClick={() => setNutShowChart((p) => !p)} style={{
            width: "100%", padding: "12px", borderRadius: 12, border: `1px solid ${C.border}`,
            background: nutShowChart ? C.accentDim : C.card, color: nutShowChart ? C.accent : C.textDim,
            fontSize: 13, fontWeight: 700, cursor: "pointer", marginBottom: nutShowChart ? 0 : 14,
            display: "flex", alignItems: "center", justifyContent: "center", gap: 8,
          }}>ğŸ“Š EvoluciÃ³n {nutShowChart ? "â–¾" : "â–¸"}</button>

          {nutShowChart && (
            <div style={{ ...baseCard, marginBottom: 14, marginTop: 8, padding: "14px 8px 8px", borderTopLeftRadius: 0, borderTopRightRadius: 0 }}>
              <div style={{ display: "flex", gap: 0, marginBottom: 12, borderRadius: 8, overflow: "hidden", border: `1px solid ${C.border}`, marginLeft: 6, marginRight: 6 }}>
                {[
                  { id: "1w", label: "1S" }, { id: "1m", label: "1M" }, { id: "3m", label: "3M" },
                  { id: "6m", label: "6M" }, { id: "1y", label: "1A" },
                ].map((f) => (
                  <button key={f.id} onClick={() => setNutChartFilter(f.id)} style={{
                    flex: 1, padding: "6px 0", border: "none", fontSize: 11, fontWeight: 700, cursor: "pointer",
                    background: nutChartFilter === f.id ? C.accentDim : C.card,
                    color: nutChartFilter === f.id ? C.accent : C.textDim,
                  }}>{f.label}</button>
                ))}
              </div>
              <ResponsiveContainer width="100%" height={200}>
                <ComposedChart data={nutChartData} margin={{ top: 5, right: 10, left: -15, bottom: 0 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" />
                  <XAxis dataKey="date" tick={{ fill: "#888", fontSize: 10 }} tickLine={false} axisLine={false}
                    interval={nutChartFilter === "1w" ? 0 : nutChartFilter === "1m" ? 4 : nutChartFilter === "3m" ? 13 : nutChartFilter === "6m" ? 29 : 59} />
                  <YAxis yAxisId="cal" tick={{ fill: "#888", fontSize: 10 }} tickLine={false} axisLine={false} />
                  <YAxis yAxisId="weight" orientation="right" tick={{ fill: "#888", fontSize: 10 }} tickLine={false} axisLine={false}
                    domain={["dataMin - 2", "dataMax + 2"]} />
                  <Tooltip
                    contentStyle={{ background: "#1a1a2e", border: "1px solid #333", borderRadius: 10, fontSize: 12 }}
                    labelStyle={{ color: "#888" }}
                    formatter={(val, name) => [name === "peso" ? `${val} kg` : `${val} kcal`, name === "ingeridas" ? "Ingeridas" : name === "quemadas" ? "Quemadas" : "Peso"]}
                  />
                  <Line yAxisId="cal" type="monotone" dataKey="ingeridas" stroke="#ff6b35" strokeWidth={2} dot={false} connectNulls />
                  <Line yAxisId="cal" type="monotone" dataKey="quemadas" stroke="#a78bfa" strokeWidth={2} dot={false} connectNulls strokeDasharray="6 3" />
                  <Line yAxisId="weight" type="monotone" dataKey="peso" stroke="#4ade80" strokeWidth={2} dot={{ r: 3, fill: "#4ade80" }} connectNulls />
                </ComposedChart>
              </ResponsiveContainer>
              <div style={{ display: "flex", justifyContent: "center", gap: 16, marginTop: 8, fontSize: 11 }}>
                <span style={{ color: "#ff6b35" }}>â” Ingeridas</span>
                <span style={{ color: "#a78bfa" }}>â•Œ Quemadas</span>
                <span style={{ color: "#4ade80" }}>â— Peso</span>
              </div>
            </div>
          )}

          {/* Meals list */}
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: C.text }}>Comidas</div>
            <div style={{ display: "flex", gap: 6 }}>
              <button onClick={() => { setNutFoodFilter(null); setNutFoodSearch(""); setNutSelectedFood(null); setNutView("addMeal"); }} style={{
                padding: "6px 14px", borderRadius: 10, border: "none", background: C.accentDim, color: C.accent, fontSize: 12, fontWeight: 700, cursor: "pointer",
              }}>+ Alimento</button>
              <button onClick={() => setNutView("addManual")} style={{
                padding: "6px 14px", borderRadius: 10, border: `1px solid ${C.border}`, background: "transparent", color: C.textDim, fontSize: 12, fontWeight: 600, cursor: "pointer",
              }}>+ Manual</button>
            </div>
          </div>

          {todayLog.meals.length === 0 ? (
            <div style={{ ...baseCard, textAlign: "center", padding: "30px 20px", color: C.textDim }}>
              <p style={{ margin: 0, fontSize: 14 }}>Sin comidas registradas</p>
            </div>
          ) : todayLog.meals.map((m) => {
            const isEditing = nutEditingMeal === m.id;
            if (isEditing) {
              const foodInfo = m.fromDB ? ALL_FOODS.find((f) => f.name === m.name) : null;
              return (
                <div key={m.id} style={{ ...baseCard, marginBottom: 8, padding: "12px 14px", borderColor: C.accent + "40" }}>
                  <div style={{ fontSize: 14, fontWeight: 700, color: C.accent, marginBottom: 10 }}>{m.name}</div>
                  {foodInfo ? (
                    <div>
                      <div style={{ fontSize: 12, color: C.textDim, marginBottom: 4 }}>Gramos:</div>
                      <input type="number" defaultValue={m.grams} id={`edit-grams-${m.id}`} autoFocus onFocus={(e) => e.target.select()}
                        style={{ width: "100%", padding: "10px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.bg, color: C.text, fontSize: 16, fontWeight: 700, outline: "none", fontFamily: font, boxSizing: "border-box", textAlign: "center" }} />
                      <div style={{ display: "flex", gap: 8, marginTop: 10 }}>
                        <button onClick={() => {
                          const g = Number(document.getElementById(`edit-grams-${m.id}`).value) || 0;
                          saveMealEdit(m.id, { grams: g, cal: Math.round(foodInfo.cal * g / 100), prot: Math.round(foodInfo.prot * g / 100 * 10) / 10 });
                        }} style={{ flex: 1, padding: "10px", borderRadius: 10, border: "none", background: C.success, color: "#000", fontSize: 13, fontWeight: 700, cursor: "pointer" }}>Guardar</button>
                        <button onClick={() => setNutEditingMeal(null)} style={{ padding: "10px 16px", borderRadius: 10, border: `1px solid ${C.border}`, background: "transparent", color: C.textDim, fontSize: 13, cursor: "pointer" }}>Cancelar</button>
                      </div>
                    </div>
                  ) : (
                    <div>
                      {[
                        { label: "CalorÃ­as", id: `edit-cal-${m.id}`, def: m.cal },
                        { label: "ProteÃ­nas (g)", id: `edit-prot-${m.id}`, def: m.prot },
                      ].map((f) => (
                        <div key={f.id} style={{ marginBottom: 8 }}>
                          <div style={{ fontSize: 12, color: C.textDim, marginBottom: 3 }}>{f.label}</div>
                          <input type="number" defaultValue={f.def} id={f.id} onFocus={(e) => e.target.select()}
                            style={{ width: "100%", padding: "8px", borderRadius: 8, border: `1px solid ${C.border}`, background: C.bg, color: C.text, fontSize: 15, fontWeight: 700, outline: "none", fontFamily: font, boxSizing: "border-box", textAlign: "center" }} />
                        </div>
                      ))}
                      <div style={{ display: "flex", gap: 8, marginTop: 10 }}>
                        <button onClick={() => {
                          saveMealEdit(m.id, {
                            cal: Number(document.getElementById(`edit-cal-${m.id}`).value) || 0,
                            prot: Number(document.getElementById(`edit-prot-${m.id}`).value) || 0,
                          });
                        }} style={{ flex: 1, padding: "10px", borderRadius: 10, border: "none", background: C.success, color: "#000", fontSize: 13, fontWeight: 700, cursor: "pointer" }}>Guardar</button>
                        <button onClick={() => setNutEditingMeal(null)} style={{ padding: "10px 16px", borderRadius: 10, border: `1px solid ${C.border}`, background: "transparent", color: C.textDim, fontSize: 13, cursor: "pointer" }}>Cancelar</button>
                      </div>
                    </div>
                  )}
                </div>
              );
            }
            return (
              <div key={m.id} onClick={() => setNutEditingMeal(m.id)}
                style={{ ...baseCard, marginBottom: 8, padding: "10px 14px", display: "flex", justifyContent: "space-between", alignItems: "center", cursor: "pointer" }}>
                <div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: C.text }}>{m.name}</div>
                  <div style={{ fontSize: 12, color: C.textDim }}>{m.grams ? `${m.grams}g Â· ` : ""}{m.cal} kcal Â· {parseFloat(Number(m.prot).toFixed(1))}g prot</div>
                </div>
                <button onClick={(e) => { e.stopPropagation(); removeMeal(m.id); }} style={{ background: "none", border: "none", color: C.danger, fontSize: 16, cursor: "pointer", padding: "4px 8px" }}>âœ•</button>
              </div>
            );
          })}

          {/* Bottom buttons */}
          <div style={{ display: "flex", gap: 8, marginTop: 16 }}>
            <button onClick={() => { setNutNewWeight(latestWeight ? String(latestWeight.weight) : ""); setNutView("weightLog"); }} style={{
              flex: 1, padding: "12px", borderRadius: 12, border: `1px solid ${C.border}`, background: C.card, color: C.textDim, fontSize: 13, fontWeight: 600, cursor: "pointer",
            }}>âš–ï¸ Peso</button>
            <button onClick={() => {
              const log = getDayLog(nutDate);
              const dateLabel = new Date(nutDate + "T12:00").toLocaleDateString("es-ES", { weekday: "long", day: "numeric", month: "long" });
              const lines = [`NutriciÃ³n Â· ${dateLabel}`];
              lines.push(`${dayTotals.cal} kcal Â· ${parseFloat(dayTotals.prot.toFixed(1))}g prot`);
              lines.push(`Basal: ${dayTotals.basalCal} | Actividad: ${dayTotals.activityCal} | Balance: ${dayTotals.balance >= 0 ? "+" : ""}${dayTotals.balance}`);
              lines.push("");
              log.meals.forEach((m) => {
                lines.push(`Â· ${m.name}${m.grams ? ` (${m.grams}g)` : ""} â€” ${m.cal} kcal, ${parseFloat(Number(m.prot).toFixed(1))}g prot`);
              });
              if (log.meals.length === 0) lines.push("(sin comidas registradas)");
              setExportData(lines.join("\n").trim());
              setExportType(`NutriciÃ³n ${nutDate}`);
            }} style={{
              flex: 1, padding: "12px", borderRadius: 12, border: `1px solid ${C.border}`, background: C.card, color: C.textDim, fontSize: 13, fontWeight: 600, cursor: "pointer",
            }}>ğŸ“¤ Compartir dÃ­a</button>
          </div>

          {/* Export con filtros */}
          <div style={{ marginTop: 20 }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: C.textDim, marginBottom: 8, textTransform: "uppercase", letterSpacing: 1 }}>Exportar</div>
            <div style={{ display: "flex", gap: 0, marginBottom: 10, borderRadius: 8, overflow: "hidden", border: `1px solid ${C.border}` }}>
              {[
                { id: "all", label: "Todo" }, { id: "1w", label: "1S" }, { id: "1m", label: "1M" },
                { id: "3m", label: "3M" }, { id: "6m", label: "6M" }, { id: "1y", label: "1A" },
              ].map((f) => (
                <button key={f.id} onClick={() => setNutExportFilter(f.id)} style={{
                  flex: 1, padding: "7px 0", border: "none", fontSize: 11, fontWeight: 700, cursor: "pointer",
                  background: nutExportFilter === f.id ? C.accentDim : C.card,
                  color: nutExportFilter === f.id ? C.accent : C.textDim,
                }}>{f.label}</button>
              ))}
            </div>
            <div style={{ display: "flex", gap: 8 }}>
              <button onClick={exportNutJSON} style={{
                flex: 1, padding: "10px", borderRadius: 10, border: `1px solid ${C.border}`, background: "transparent", color: C.textDim, fontSize: 12, fontWeight: 600, cursor: "pointer",
              }}>JSON</button>
              <button onClick={exportNutCSV} style={{
                flex: 1, padding: "10px", borderRadius: 10, border: `1px solid ${C.border}`, background: "transparent", color: C.textDim, fontSize: 12, fontWeight: 600, cursor: "pointer",
              }}>CSV</button>
            </div>
          </div>

        </div>
      );
    }

    // â”€â”€ Add from DB â”€â”€
    if (nutView === "addMeal") {
      const q = nutFoodSearch.toLowerCase();
      const filtered = ALL_FOODS.filter((f) =>
        (!nutFoodFilter || f.group === nutFoodFilter) &&
        (!q || f.name.toLowerCase().includes(q))
      );

      if (nutSelectedFood) {
        const f = nutSelectedFood;
        const g = Number(nutGrams) || 0;
        return (
          <div style={{ padding: "0 20px 100px" }}>
            <div style={{ paddingTop: 16, marginBottom: 20, display: "flex", alignItems: "center", gap: 12 }}>
              <button onClick={() => setNutSelectedFood(null)} style={{ background: "none", border: "none", color: C.accent, fontSize: 28, cursor: "pointer", padding: 0 }}>â€¹</button>
              <h1 style={{ fontSize: 20, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>{f.name}</h1>
            </div>
            <div style={{ ...baseCard, marginBottom: 16, padding: 16 }}>
              <div style={{ fontSize: 12, color: C.textDim, marginBottom: 8 }}>Por 100g: {f.cal} kcal Â· {f.prot}g prot</div>
              <div style={{ fontSize: 13, color: C.textDim, marginBottom: 8 }}>Gramos:</div>
              <input type="number" value={nutGrams} onChange={(e) => setNutGrams(e.target.value)} autoFocus
                onFocus={(e) => e.target.select()}
                style={{ width: "100%", padding: "14px", borderRadius: 12, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 20, fontWeight: 700, outline: "none", fontFamily: font, boxSizing: "border-box", textAlign: "center" }} />
              <div style={{ display: "flex", gap: 6, marginTop: 10, flexWrap: "wrap" }}>
                {[50, 100, 150, 200, 250, 300].map((v) => (
                  <button key={v} onClick={() => setNutGrams(String(v))} style={{
                    padding: "6px 14px", borderRadius: 8, fontSize: 13, fontWeight: 600, cursor: "pointer",
                    border: `1px solid ${nutGrams === String(v) ? C.accent : C.border}`,
                    background: nutGrams === String(v) ? C.accentDim : C.card,
                    color: nutGrams === String(v) ? C.accent : C.textDim,
                  }}>{v}g</button>
                ))}
              </div>
              {g > 0 && (
                <div style={{ marginTop: 14, padding: "12px", borderRadius: 10, background: "rgba(255,255,255,0.03)", textAlign: "center" }}>
                  <span style={{ fontSize: 18, fontWeight: 700, color: C.accent }}>{Math.round(f.cal * g / 100)} kcal</span>
                  <span style={{ fontSize: 14, color: C.textDim, marginLeft: 12 }}>{Math.round(f.prot * g / 100 * 10) / 10}g prot</span>
                </div>
              )}
            </div>
            <button onClick={addMealFromDB} style={{
              width: "100%", padding: "16px", borderRadius: 14, border: "none",
              background: `linear-gradient(135deg, ${C.accent}, #ff8f35)`, color: "#fff",
              fontSize: 15, fontWeight: 700, cursor: "pointer", fontFamily: font,
            }}>AÃ±adir</button>
          </div>
        );
      }

      return (
        <div style={{ padding: "0 20px 100px" }}>
          <div style={{ paddingTop: 16, marginBottom: 16, display: "flex", alignItems: "center", gap: 12 }}>
            <button onClick={() => setNutView("summary")} style={{ background: "none", border: "none", color: C.accent, fontSize: 28, cursor: "pointer", padding: 0 }}>â€¹</button>
            <h1 style={{ fontSize: 20, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>AÃ±adir alimento</h1>
          </div>
          <input type="search" placeholder="Buscar alimento..." value={nutFoodSearch} onChange={(e) => setNutFoodSearch(e.target.value)}
            style={{ width: "100%", padding: "12px 16px", borderRadius: 12, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 14, outline: "none", marginBottom: 12, boxSizing: "border-box", fontFamily: fontBody }} />

          <button onClick={() => setShowNewFood(true)} style={{
            width: "100%", padding: "12px", borderRadius: 12, border: `1px dashed ${C.accent}60`,
            background: C.accentDim, color: C.accent, fontSize: 14, fontWeight: 600,
            cursor: "pointer", marginBottom: 16, fontFamily: fontBody,
          }}>â­ Crear alimento personalizado</button>

          {showNewFood && (
            <div style={{ ...baseCard, marginBottom: 16, borderColor: C.accent }}>
              <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 12 }}>Nuevo alimento</div>
              <input type="text" placeholder="Nombre del alimento" value={newFoodName}
                onChange={(e) => setNewFoodName(e.target.value)}
                style={{ width: "100%", padding: "12px 14px", borderRadius: 10, border: `1px solid ${C.border}`, background: "rgba(255,255,255,0.04)", color: C.text, fontSize: 14, outline: "none", boxSizing: "border-box", marginBottom: 10, fontFamily: fontBody }} />
              <div style={{ fontSize: 12, color: C.textDim, marginBottom: 6, fontWeight: 600 }}>GRUPO</div>
              <div style={{ display: "flex", flexWrap: "wrap", gap: 6, marginBottom: 12 }}>
                {ALL_FOOD_GROUPS.map((g) => (
                  <button key={g} onClick={() => setNewFoodGroup(g)} style={{
                    padding: "6px 12px", borderRadius: 16, fontSize: 12, fontWeight: 600, cursor: "pointer",
                    border: `1px solid ${newFoodGroup === g ? C.accent : C.border}`,
                    background: newFoodGroup === g ? C.accentDim : "transparent",
                    color: newFoodGroup === g ? C.accent : C.textDim,
                  }}>{g}</button>
                ))}
              </div>
              <div style={{ fontSize: 12, color: C.textDim, marginBottom: 6, fontWeight: 600 }}>VALORES POR 100g</div>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginBottom: 14 }}>
                <input type="number" inputMode="numeric" placeholder="CalorÃ­as (kcal)" value={newFoodCal}
                  onChange={(e) => setNewFoodCal(e.target.value)}
                  style={{ padding: "10px 12px", borderRadius: 10, border: `1px solid ${C.border}`, background: "rgba(255,255,255,0.04)", color: C.text, fontSize: 14, outline: "none", boxSizing: "border-box", fontFamily: fontBody }} />
                <input type="number" inputMode="decimal" placeholder="ProteÃ­na (g)" value={newFoodProt}
                  onChange={(e) => setNewFoodProt(e.target.value)}
                  style={{ padding: "10px 12px", borderRadius: 10, border: `1px solid ${C.border}`, background: "rgba(255,255,255,0.04)", color: C.text, fontSize: 14, outline: "none", boxSizing: "border-box", fontFamily: fontBody }} />
              </div>
              <div style={{ display: "flex", gap: 8 }}>
                <button onClick={addCustomFood} style={{
                  flex: 1, padding: "10px", borderRadius: 10, border: "none",
                  background: C.accent, color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer",
                }}>AÃ±adir</button>
                <button onClick={() => { setShowNewFood(false); setNewFoodName(""); setNewFoodCal(""); setNewFoodProt(""); }} style={{
                  padding: "10px 16px", borderRadius: 10, border: `1px solid ${C.border}`,
                  background: "transparent", color: C.textDim, fontSize: 14, cursor: "pointer",
                }}>Cancelar</button>
              </div>
            </div>
          )}

          <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 16 }}>
            <button onClick={() => setNutFoodFilter(null)} style={{
              padding: "6px 12px", borderRadius: 8, fontSize: 12, fontWeight: 600, cursor: "pointer",
              border: `1px solid ${!nutFoodFilter ? C.accent : C.border}`,
              background: !nutFoodFilter ? C.accentDim : "transparent",
              color: !nutFoodFilter ? C.accent : C.textDim,
            }}>Todos</button>
            {ALL_FOOD_GROUPS.map((g) => (
              <button key={g} onClick={() => setNutFoodFilter(g)} style={{
                padding: "6px 12px", borderRadius: 8, fontSize: 12, fontWeight: 600, cursor: "pointer",
                border: `1px solid ${nutFoodFilter === g ? C.accent : C.border}`,
                background: nutFoodFilter === g ? C.accentDim : "transparent",
                color: nutFoodFilter === g ? C.accent : C.textDim,
              }}>{g}</button>
            ))}
          </div>
          {filtered.map((f) => {
            const isCustomFood = f.id.startsWith("custom_food_");
            return (
              <div key={f.id} style={{ ...baseCard, marginBottom: 6, padding: "10px 14px", display: "flex", alignItems: "center" }}>
                <div onClick={() => setNutSelectedFood(f)} style={{ flex: 1, cursor: "pointer", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 600, color: C.text }}>{f.name}</div>
                    <div style={{ fontSize: 11, color: C.textDim }}>{f.group}{isCustomFood && <span style={{ color: C.accent, marginLeft: 6 }}>personalizado</span>}</div>
                  </div>
                  <div style={{ textAlign: "right" }}>
                    <div style={{ fontSize: 13, fontWeight: 700, color: C.accent }}>{f.cal} kcal</div>
                    <div style={{ fontSize: 11, color: C.textDim }}>{f.prot}g prot</div>
                  </div>
                </div>
                {isCustomFood && (
                  <button onClick={(e) => { e.stopPropagation(); deleteCustomFood(f.id); }}
                    style={{ background: "none", border: "none", color: C.danger, fontSize: 16, cursor: "pointer", padding: "4px 8px", marginLeft: 8 }}>âœ•</button>
                )}
              </div>
            );
          })}
          {filtered.length === 0 && <div style={{ textAlign: "center", color: C.textDim, padding: 30, fontSize: 14 }}>No se encontraron alimentos</div>}
        </div>
      );
    }

    // â”€â”€ Manual entry â”€â”€
    if (nutView === "addManual") {
      return (
        <div style={{ padding: "0 20px 100px" }}>
          <div style={{ paddingTop: 16, marginBottom: 20, display: "flex", alignItems: "center", gap: 12 }}>
            <button onClick={() => setNutView("summary")} style={{ background: "none", border: "none", color: C.accent, fontSize: 28, cursor: "pointer", padding: 0 }}>â€¹</button>
            <h1 style={{ fontSize: 20, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>Entrada manual</h1>
          </div>
          <div style={{ ...baseCard, padding: 16 }}>
            {[
              { label: "Nombre (opcional)", val: nutManualName, set: setNutManualName, type: "text", ph: "Ej: Cena restaurante" },
              { label: "CalorÃ­as (kcal)", val: nutManualCal, set: setNutManualCal, type: "number", ph: "500" },
              { label: "ProteÃ­nas (g)", val: nutManualProt, set: setNutManualProt, type: "number", ph: "30" },
            ].map((f, i) => (
              <div key={i} style={{ marginBottom: 14 }}>
                <div style={{ fontSize: 12, color: C.textDim, marginBottom: 4 }}>{f.label}</div>
                <input type={f.type} placeholder={f.ph} value={f.val} onChange={(e) => f.set(e.target.value)}
                  style={{ width: "100%", padding: "12px", borderRadius: 10, border: `1px solid ${C.border}`, background: C.bg, color: C.text, fontSize: 15, outline: "none", fontFamily: fontBody, boxSizing: "border-box" }} />
              </div>
            ))}
          </div>
          <button onClick={addManualMeal} disabled={!nutManualCal} style={{
            width: "100%", padding: "16px", borderRadius: 14, border: "none",
            background: nutManualCal ? `linear-gradient(135deg, ${C.accent}, #ff8f35)` : C.border, color: nutManualCal ? "#fff" : C.textDim,
            fontSize: 15, fontWeight: 700, cursor: nutManualCal ? "pointer" : "default", marginTop: 16, fontFamily: font,
          }}>AÃ±adir</button>
        </div>
      );
    }

    // â”€â”€ Weight log â”€â”€
    if (nutView === "weightLog") {
      const last10 = [...weightLog].reverse();
      return (
        <div style={{ padding: "0 20px 100px" }}>
          <div style={{ paddingTop: 16, marginBottom: 20, display: "flex", alignItems: "center", gap: 12 }}>
            <button onClick={() => setNutView("summary")} style={{ background: "none", border: "none", color: C.accent, fontSize: 28, cursor: "pointer", padding: 0 }}>â€¹</button>
            <h1 style={{ fontSize: 20, fontWeight: 700, color: C.text, margin: 0, fontFamily: font }}>âš–ï¸ Registro de Peso</h1>
          </div>
          <div style={{ ...baseCard, padding: 16, marginBottom: 16 }}>
            <div style={{ fontSize: 12, color: C.textDim, marginBottom: 6 }}>Peso hoy ({nutDate})</div>
            <div style={{ display: "flex", gap: 8 }}>
              <input type="number" step="0.1" placeholder="80.0" value={nutNewWeight} onChange={(e) => setNutNewWeight(e.target.value)}
                onFocus={(e) => e.target.select()}
                style={{ flex: 1, padding: "12px", borderRadius: 10, border: `1px solid ${C.border}`, background: C.bg, color: C.text, fontSize: 18, fontWeight: 700, outline: "none", fontFamily: font, boxSizing: "border-box", textAlign: "center" }} />
              <button onClick={addWeight} disabled={!nutNewWeight} style={{
                padding: "12px 24px", borderRadius: 10, border: "none",
                background: nutNewWeight ? C.accent : C.border, color: nutNewWeight ? "#fff" : C.textDim,
                fontSize: 14, fontWeight: 700, cursor: nutNewWeight ? "pointer" : "default",
              }}>Guardar</button>
            </div>
          </div>
          {last10.length > 0 && (
            <>
              <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 10 }}>Ãšltimos registros</div>
              {last10.map((w, i) => (
                <div key={i} style={{ ...baseCard, marginBottom: 6, padding: "10px 14px", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                  <span style={{ fontSize: 13, color: C.textDim }}>{new Date(w.date + "T12:00").toLocaleDateString("es-ES", { day: "numeric", month: "short" })}</span>
                  <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                    <span style={{ fontSize: 15, fontWeight: 700, color: C.text }}>{w.weight} kg</span>
                    <button onClick={() => setWeightLog((prev) => prev.filter((x) => x.date !== w.date))}
                      style={{ background: "none", border: "none", color: C.danger, fontSize: 14, cursor: "pointer", padding: "2px 6px" }}>âœ•</button>
                  </div>
                </div>
              ))}
            </>
          )}
        </div>
      );
    }


    return null;
  };

  // â•â•â• COACH IA (GEMINI) â•â•â•
  const buildSystemPrompt = () => {
    const now = new Date();
    const weekAgo = new Date(now); weekAgo.setDate(weekAgo.getDate() - 28);
    const week5ago = new Date(now); week5ago.setDate(week5ago.getDate() - 56);

    // Exercise catalog with IDs
    const catalog = Object.entries(EXERCISES).map(([g, exs]) =>
      `${g}: ${exs.map(e => `${e.name} [${e.id}]`).join(", ")}`
    ).join("\n");

    // Last 4 weeks workouts (detailed)
    const recentWorkouts = workouts
      .filter(w => new Date(w.date) >= weekAgo)
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .slice(0, 30)
      .map(w => {
        const d = new Date(w.date).toLocaleDateString("es-ES", { weekday: "short", day: "numeric", month: "short" });
        const exs = w.exercises.map(ex => {
          const info = getExerciseInfo(ex.exerciseId);
          const name = info ? info.name : ex.exerciseId;
          const sets = (ex.sets || []).map(s => {
            if (s.weight) return `${s.weight}kgÃ—${s.reps}`;
            if (s.reps) return `${s.reps} reps`;
            if (s.time) return `${s.time}s`;
            return "âœ“";
          }).join(", ");
          return `  ${name}: ${sets}`;
        }).join("\n");
        return `${d}${w.circuit ? " [Circuito]" : ""}:\n${exs}`;
      }).join("\n\n");

    // Weeks 5-8 summary
    const olderWorkouts = workouts.filter(w => {
      const d = new Date(w.date);
      return d >= week5ago && d < weekAgo;
    });
    const groupFreq = {};
    olderWorkouts.forEach(w => {
      w.exercises.forEach(ex => {
        const info = getExerciseInfo(ex.exerciseId);
        if (info) {
          const g = Object.entries(EXERCISES).find(([, exs]) => exs.some(e => e.id === ex.exerciseId));
          if (g) groupFreq[g[0]] = (groupFreq[g[0]] || 0) + 1;
        }
      });
    });
    const olderSummary = Object.entries(groupFreq).map(([g, n]) => `${g}: ${n} ejercicios`).join(", ") || "Sin datos";

    // Plans
    const plansSummary = plans.length > 0
      ? plans.map(p => `"${p.name}": ${(p.exercises || []).map(ex => { const info = getExerciseInfo(ex.exerciseId); return info ? info.name : ex.exerciseId; }).join(", ")}`).join("\n")
      : "Sin planes guardados";

    // Nutrition last 7 days
    const nutDays = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(now); d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0, 10);
      const entry = nutritionLog[key];
      if (entry) {
        const totalCal = (entry.meals || []).reduce((s, m) => s + (m.cal || 0), 0);
        const totalProt = (entry.meals || []).reduce((s, m) => s + (m.prot || 0), 0);
        const basal = entry.basalCal || nutSettings.basalCal;
        const activity = entry.activityCal || 0;
        const balance = basal + activity - totalCal;
        nutDays.push(`${key}: ${Math.round(totalCal)} kcal, ${Math.round(totalProt)}g prot, balance ${balance > 0 ? "+" : ""}${Math.round(balance)}`);
      }
    }
    const nutSummary = nutDays.length > 0 ? nutDays.join("\n") : "Sin datos de nutriciÃ³n recientes";

    // Weight
    const recentWeight = weightLog.slice(-10).map(w => `${w.date}: ${w.weight} kg`).join(", ") || "Sin registros";

    // Global stats
    const totalWorkouts = workouts.length;
    const thisWeek = workouts.filter(w => {
      const d = new Date(w.date);
      const diff = (now - d) / (1000 * 60 * 60 * 24);
      return diff <= 7;
    }).length;
    const totalVolume = workouts.reduce((sum, w) =>
      sum + w.exercises.reduce((s, ex) =>
        s + (ex.sets || []).reduce((ss, set) =>
          ss + (Number(set.weight) || 0) * (Number(set.reps) || 0), 0), 0), 0);

    const lengthInstr = { conciso: "Responde de forma MUY breve y directa, mÃ¡ximo 2-3 pÃ¡rrafos cortos. Ve al grano sin rodeos.", normal: "Responde de forma concisa pero completa, sin excederte.", detallado: "Puedes extenderte y dar explicaciones detalladas cuando sea Ãºtil." }[coachLength] || "";

    return `Eres un entrenador personal y nutricionista deportivo experto. Hablas en espaÃ±ol, eres motivador, directo y prÃ¡ctico. Tuteas al usuario.
${lengthInstr}
${coachContext ? `\nCONTEXTO DEL USUARIO (IMPORTANTE, tenlo siempre en cuenta):\n${coachContext}\n` : ""}

CATÃLOGO DE EJERCICIOS DISPONIBLES (usa SOLO estos nombres al proponer ejercicios):
${catalog}

ENTRENAMIENTOS ÃšLTIMAS 4 SEMANAS (detallado):
${recentWorkouts || "Sin entrenamientos recientes"}

SEMANAS 5-8 (resumen frecuencia por grupo):
${olderSummary}

PLANES GUARDADOS:
${plansSummary}

NUTRICIÃ“N ÃšLTIMOS 7 DÃAS:
${nutSummary}
Objetivos: ${nutSettings.basalCal} kcal basales, ${nutSettings.protTarget}g proteÃ­na

PESO CORPORAL RECIENTE:
${recentWeight}

ESTADÃSTICAS:
- Total entrenamientos: ${totalWorkouts}
- Esta semana: ${thisWeek}
- Volumen total acumulado: ${Math.round(totalVolume)} kg

INSTRUCCIONES:
- Al proponer ejercicios, usa EXACTAMENTE los nombres del catÃ¡logo
- SÃ© especÃ­fico con series, repeticiones y pesos basÃ¡ndote en el historial
- Adapta las recomendaciones al nivel y progresiÃ³n real del usuario
- Si preguntan por nutriciÃ³n, basa tu respuesta en los datos reales
- Responde de forma concisa pero completa
- Usa formato con negritas (**texto**) y listas cuando sea Ãºtil

PLANES DE ENTRENAMIENTO:
Cuando el usuario te pida crear/proponer un plan, rutina o entrenamiento, SIEMPRE incluye al final de tu respuesta un bloque JSON con este formato EXACTO:
\`\`\`plan
{"name":"Nombre del plan","exercises":[{"id":"exercise_id","sets":3,"reps":"10","weight":"80"}]}
\`\`\`
- Usa los IDs del catÃ¡logo (entre corchetes [id])
- "weight" es string en kg, dÃ©jalo "" para ejercicios bodyweight
- "reps" es string con un nÃºmero ENTERO (ej: "10", "12", "15"). NUNCA uses rangos como "8-10" ni texto como "al fallo"
- "weight" debe ser un nÃºmero ENTERO sin unidades (ej: "80", "30"). NUNCA "80kg", NUNCA rangos ni "BW"
- "reps" NUNCA con unidades (ej: "10", NO "10s" ni "60s"). Para ejercicios de tiempo pon los segundos como nÃºmero
- "sets" debe ser un nÃºmero ENTERO (ej: 3, 4)
- Puedes generar VARIOS bloques \`\`\`plan si el usuario pide varios dÃ­as/planes
- Explica el plan en texto normal ANTES del bloque JSON
- Si el usuario pide un plan semanal con varios dÃ­as, genera un bloque \`\`\`plan por cada dÃ­a`;
  };

  const sendToGemini = async (userMessage) => {
    if (!geminiKey) {
      setChatError("Configura tu API Key de Gemini en âš™ï¸ Ajustes");
      return;
    }
    const trimmed = userMessage.trim();
    if (!trimmed) return;

    const userMsg = { role: "user", text: trimmed, ts: Date.now() };
    setChatMessages(prev => [...prev, userMsg]);
    setChatInput("");
    if (chatInputRef.current) chatInputRef.current.style.height = "auto";
    setChatLoading(true);
    setChatError(null);

    try {
      const history = [...chatMessages, userMsg].slice(-20);
      const contents = history.map(m => ({
        role: m.role === "user" ? "user" : "model",
        parts: [{ text: m.text }],
      }));

      const sysPrompt = buildSystemPrompt();
      const payload = {
        systemInstruction: { parts: [{ text: sysPrompt }] },
        contents,
        generationConfig: { temperature: 0.7, maxOutputTokens: 8192 },
      };
      console.log(`[Coach] System prompt: ~${Math.round(sysPrompt.length / 4)} tokens, Messages: ${contents.length}, Payload: ~${Math.round(JSON.stringify(payload).length / 4)} tokens`);

      const res = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiKey}`,
        { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) }
      );

      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        if (res.status === 429) throw new Error("Rate limit: " + (errData.error?.message || "Espera un momento y reintenta"));
        throw new Error(errData.error?.message || `Error ${res.status}`);
      }

      const data = await res.json();
      const reply = data.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!reply) throw new Error("Respuesta vacÃ­a del modelo");

      setChatMessages(prev => [...prev, { role: "model", text: reply, ts: Date.now() }]);
    } catch (err) {
      setChatError(err.message || "Error de conexiÃ³n");
    } finally {
      setChatLoading(false);
    }
  };

  const resolveExerciseId = (ex) => {
    // Try direct ID
    if (ex.id && getExerciseInfo(ex.id)) return ex.id;
    if (ex.exerciseId && getExerciseInfo(ex.exerciseId)) return ex.exerciseId;
    // Try by name
    const name = ex.name || ex.nombre || "";
    if (name) {
      const found = ALL_EXERCISES.find(e => e.name.toLowerCase() === name.toLowerCase());
      if (found) return found.id;
      // Fuzzy: contains
      const fuzzy = ALL_EXERCISES.find(e => e.name.toLowerCase().includes(name.toLowerCase()) || name.toLowerCase().includes(e.name.toLowerCase()));
      if (fuzzy) return fuzzy.id;
    }
    return null;
  };

  const normalizePlan = (parsed) => {
    if (!parsed || typeof parsed !== "object") return null;
    const name = parsed.name || parsed.nombre || "Plan del Coach";
    const rawExercises = Array.isArray(parsed.exercises) ? parsed.exercises
      : Array.isArray(parsed.ejercicios) ? parsed.ejercicios : null;
    if (!rawExercises) return null;
    const num = (v) => String(v).replace(/[^0-9.]/g, "");
    const exercises = rawExercises.map(ex => ({
      id: resolveExerciseId(ex),
      sets: parseInt(ex.sets || ex.series) || 3,
      reps: num(ex.reps || ex.repeticiones || ""),
      weight: num(ex.weight || ex.peso || ""),
      rawName: ex.name || ex.nombre || ex.id || "?",
    })).filter(ex => ex.id);
    if (exercises.length === 0) return null;
    return { name, exercises, _totalRaw: rawExercises.length };
  };

  const savePlanFromCoach = (planData) => {
    const exercises = planData.exercises.map(ex => ({
      exerciseId: ex.id, numSets: ex.sets || 3,
      reps: String(ex.reps || ""), weight: String(ex.weight || ""),
    }));
    if (exercises.length === 0) return;
    const plan = {
      id: Date.now().toString(),
      name: planData.name,
      createdAt: new Date().toISOString(),
      exercises,
    };
    setPlans(prev => [...prev, plan]);
    return plan;
  };

  const [savedPlanIds, setSavedPlanIds] = useState(new Set());

  const renderPlanCard = (planData, key) => {
    if (!planData || !Array.isArray(planData.exercises)) return null;
    const validExercises = planData.exercises;
    const isSaved = savedPlanIds.has(key);
    return (
      <div key={key} style={{
        margin: "10px 0", padding: 14, borderRadius: 14,
        background: "rgba(255,107,53,0.08)", border: `1px solid ${C.accent}30`,
      }}>
        <div style={{ fontSize: 14, fontWeight: 700, color: C.accent, marginBottom: 10 }}>ğŸ“‹ {planData.name}</div>
        <div style={{ display: "flex", flexDirection: "column", gap: 4, marginBottom: 12 }}>
          {validExercises.map((ex, j) => {
            const info = getExerciseInfo(ex.id);
            return (
              <div key={j} style={{ fontSize: 12, color: C.text, display: "flex", justifyContent: "space-between" }}>
                <span>{info.emoji} {info.name}</span>
                <span style={{ color: C.textDim }}>{ex.sets}Ã—{ex.reps}{ex.weight ? ` @ ${ex.weight}kg` : ""}</span>
              </div>
            );
          })}
          {planData._totalRaw > validExercises.length && (
            <div style={{ fontSize: 11, color: C.danger }}>
              âš ï¸ {planData._totalRaw - validExercises.length} ejercicio(s) no reconocido(s)
            </div>
          )}
        </div>
        <button
          disabled={isSaved || validExercises.length === 0}
          onClick={() => {
            const saved = savePlanFromCoach(planData);
            if (saved) setSavedPlanIds(prev => new Set([...prev, key]));
          }}
          style={{
            width: "100%", padding: "10px", borderRadius: 10, border: "none",
            background: isSaved ? C.success : `linear-gradient(135deg, ${C.accent}, #ff8f35)`,
            color: "#fff", fontSize: 13, fontWeight: 700, cursor: isSaved ? "default" : "pointer",
          }}
        >
          {isSaved ? "âœ“ Guardado en Mis Planes" : "ğŸ’¾ Guardar en Mis Planes"}
        </button>
      </div>
    );
  };

  const renderMarkdown = (text) => {
    // Split text into segments: regular text and plan blocks
    const segments = [];
    let lastIndex = 0;
    const planRegex = /```plan\s*\n?([\s\S]*?)```/g;
    let match;
    let planCounter = 0;
    while ((match = planRegex.exec(text)) !== null) {
      if (match.index > lastIndex) segments.push({ type: "text", content: text.slice(lastIndex, match.index) });
      try {
        const parsed = JSON.parse(match[1].trim());
        const normalized = normalizePlan(parsed);
        if (normalized) segments.push({ type: "plan", data: normalized, idx: planCounter++ });
      } catch {}
      lastIndex = match.index + match[0].length;
    }
    if (lastIndex < text.length) segments.push({ type: "text", content: text.slice(lastIndex) });

    const elements = [];
    segments.forEach((seg, si) => {
      if (seg.type === "plan") {
        elements.push(renderPlanCard(seg.data, `plan-${seg.idx}-${seg.data.name}`));
        return;
      }
      const lines = seg.content.split("\n");
      let i = 0;
      while (i < lines.length) {
        const line = lines[i];
        const lineKey = `${si}-${i}`;
        if (line.startsWith("### ")) {
          elements.push(<div key={lineKey} style={{ fontSize: 14, fontWeight: 700, color: C.text, marginTop: 10, marginBottom: 4 }}>{line.slice(4)}</div>);
        } else if (line.startsWith("## ")) {
          elements.push(<div key={lineKey} style={{ fontSize: 15, fontWeight: 700, color: C.text, marginTop: 10, marginBottom: 4 }}>{line.slice(3)}</div>);
        } else if (/^\d+\.\s/.test(line)) {
          const items = [];
          while (i < lines.length && /^\d+\.\s/.test(lines[i])) { items.push(lines[i].replace(/^\d+\.\s/, "")); i++; }
          elements.push(
            <ol key={`ol-${lineKey}`} style={{ margin: "4px 0", paddingLeft: 20, fontSize: 13, color: C.text, lineHeight: 1.6 }}>
              {items.map((item, j) => <li key={j}>{renderInline(item)}</li>)}
            </ol>
          );
          continue;
        } else if (line.startsWith("- ") || line.startsWith("* ")) {
          const items = [];
          while (i < lines.length && (lines[i].startsWith("- ") || lines[i].startsWith("* "))) { items.push(lines[i].slice(2)); i++; }
          elements.push(
            <ul key={`ul-${lineKey}`} style={{ margin: "4px 0", paddingLeft: 20, fontSize: 13, color: C.text, lineHeight: 1.6 }}>
              {items.map((item, j) => <li key={j}>{renderInline(item)}</li>)}
            </ul>
          );
          continue;
        } else if (line.trim() === "") {
          elements.push(<div key={lineKey} style={{ height: 6 }} />);
        } else {
          elements.push(<div key={lineKey} style={{ fontSize: 13, color: C.text, lineHeight: 1.6, marginBottom: 2 }}>{renderInline(line)}</div>);
        }
        i++;
      }
    });
    return elements;
  };

  const renderInline = (text) => {
    const parts = text.split(/(\*\*[^*]+\*\*)/g);
    return parts.map((part, i) => {
      if (part.startsWith("**") && part.endsWith("**")) {
        return <strong key={i} style={{ fontWeight: 700, color: C.accent }}>{part.slice(2, -2)}</strong>;
      }
      return <span key={i}>{part}</span>;
    });
  };

  const renderCoach = () => {
    const suggestions = [
      "PropÃ³n entrenamiento de pecho",
      "Analiza mi semana",
      "Â¿CÃ³mo va mi nutriciÃ³n?",
      "Dame una rutina full body",
      "Â¿Estoy progresando bien?",
    ];

    return (
      <div style={{ display: "flex", flexDirection: "column", height: "100vh", paddingBottom: 140 }}>
        {/* Header */}
        <div style={{ padding: "16px 20px 12px", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <h1 style={{ fontSize: 24, fontWeight: 800, color: C.text, margin: 0, fontFamily: font, letterSpacing: "-0.5px" }}>ğŸ¤– Coach IA</h1>
          {chatMessages.length > 0 && (
            <button onClick={() => { if (confirm("Â¿Limpiar toda la conversaciÃ³n?")) setChatMessages([]); }}
              style={{ background: "none", border: `1px solid ${C.border}`, borderRadius: 8, color: C.textDim, fontSize: 12, padding: "6px 12px", cursor: "pointer" }}>
              Limpiar
            </button>
          )}
        </div>

        {/* API key warning */}
        {!geminiKey && (
          <div style={{ margin: "0 20px 12px", padding: "12px 16px", borderRadius: 12, background: `${C.danger}15`, border: `1px solid ${C.danger}30` }}>
            <div style={{ fontSize: 13, color: C.danger, fontWeight: 600 }}>âš ï¸ API Key no configurada</div>
            <div style={{ fontSize: 12, color: C.textDim, marginTop: 4 }}>Ve a âš™ï¸ Ajustes para configurar tu API Key de Gemini</div>
          </div>
        )}

        {/* Messages area */}
        <div style={{ flex: 1, overflowY: "auto", padding: "0 20px", WebkitOverflowScrolling: "touch" }}>
          {chatMessages.length === 0 && !chatLoading ? (
            <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", paddingTop: 60 }}>
              <div style={{ fontSize: 48, marginBottom: 16 }}>ğŸ‹ï¸</div>
              <div style={{ fontSize: 16, fontWeight: 700, color: C.text, marginBottom: 8, fontFamily: font }}>Tu entrenador personal IA</div>
              <div style={{ fontSize: 13, color: C.textDim, textAlign: "center", lineHeight: 1.5, marginBottom: 24, maxWidth: 280 }}>
                Conoce tu historial de entrenamientos y nutriciÃ³n. PregÃºntale lo que quieras.
              </div>
              <div style={{ display: "flex", flexWrap: "wrap", gap: 8, justifyContent: "center", maxWidth: 340 }}>
                {suggestions.map((s, i) => (
                  <button key={i} onClick={() => sendToGemini(s)}
                    style={{
                      padding: "8px 14px", borderRadius: 20, border: `1px solid ${C.accent}40`,
                      background: C.accentDim, color: C.accent, fontSize: 12, fontWeight: 600,
                      cursor: "pointer", whiteSpace: "nowrap",
                    }}>
                    {s}
                  </button>
                ))}
              </div>
            </div>
          ) : (
            <>
              {chatMessages.map((msg, i) => (
                <div key={i} style={{
                  display: "flex", justifyContent: msg.role === "user" ? "flex-end" : "flex-start",
                  marginBottom: 10,
                }}>
                  <div style={{
                    maxWidth: "85%",
                    padding: msg.role === "user" ? "10px 14px" : "12px 16px",
                    borderRadius: msg.role === "user" ? "16px 16px 4px 16px" : "16px 16px 16px 4px",
                    background: msg.role === "user" ? C.accent : C.card,
                    border: msg.role === "user" ? "none" : `1px solid ${C.border}`,
                    color: msg.role === "user" ? "#fff" : C.text,
                    fontSize: 13, lineHeight: 1.5,
                  }}>
                    {msg.role === "user" ? msg.text : renderMarkdown(msg.text)}
                  </div>
                </div>
              ))}
            </>
          )}

          {/* Loading indicator */}
          {chatLoading && (
            <div style={{ display: "flex", justifyContent: "flex-start", marginBottom: 10 }}>
              <div style={{ ...baseCard, padding: "12px 18px", display: "flex", gap: 4, alignItems: "center" }}>
                {[0, 1, 2].map(i => (
                  <div key={i} style={{
                    width: 7, height: 7, borderRadius: "50%", background: C.accent,
                    animation: `blink 1.4s infinite ${i * 0.2}s`,
                  }} />
                ))}
              </div>
            </div>
          )}

          {/* Error */}
          {chatError && (
            <div style={{
              margin: "8px 0", padding: "10px 14px", borderRadius: 12,
              background: C.dangerDim, border: `1px solid ${C.danger}40`,
              fontSize: 13, color: C.danger,
            }}>
              {chatError}
            </div>
          )}

          <div ref={chatEndRef} />
        </div>

        {/* Input bar */}
        <div style={{
          position: "fixed", bottom: 80, left: "50%", transform: "translateX(-50%)",
          width: "100%", maxWidth: 480, padding: "12px 20px",
          background: `linear-gradient(to top, ${C.bg} 80%, transparent)`,
          boxSizing: "border-box",
        }}>
          <div style={{ display: "flex", gap: 8 }}>
            <textarea
              ref={chatInputRef}
              value={chatInput}
              onChange={e => { setChatInput(e.target.value); e.target.style.height = "auto"; e.target.style.height = Math.min(e.target.scrollHeight, 120) + "px"; }}
              onKeyDown={e => { if (e.key === "Enter" && !e.shiftKey && !e.ctrlKey && !chatLoading && chatInput.trim()) { e.preventDefault(); sendToGemini(chatInput); } }}
              placeholder="Pregunta a tu coach..."
              rows={1}
              style={{
                flex: 1, padding: "12px 16px", borderRadius: 14,
                border: `1px solid ${C.border}`, background: C.card, color: C.text,
                fontSize: 14, outline: "none", fontFamily: fontBody,
                resize: "none", lineHeight: 1.4, maxHeight: 120, overflowY: "auto",
              }}
            />
            <button
              onClick={() => sendToGemini(chatInput)}
              disabled={chatLoading || !chatInput.trim()}
              style={{
                width: 46, minHeight: 46, borderRadius: 14, border: "none",
                background: chatInput.trim() && !chatLoading ? C.accent : C.border,
                color: "#fff", fontSize: 18, cursor: chatInput.trim() && !chatLoading ? "pointer" : "default",
                display: "flex", alignItems: "center", justifyContent: "center",
                transition: "background 0.2s", alignSelf: "flex-end",
              }}
            >
              â¤
            </button>
          </div>
        </div>
      </div>
    );
  };

  // â•â•â• CONFIG / AJUSTES â•â•â•
  const renderConfig = () => (
    <div style={{ padding: "0 20px 100px" }}>
      <div style={{ paddingTop: 16, marginBottom: 28 }}>
        <h1 style={{ fontSize: 24, fontWeight: 800, color: C.text, margin: 0, fontFamily: font, letterSpacing: "-0.5px" }}>âš™ï¸ Ajustes</h1>
      </div>

      {/* Objetivos nutricionales */}
      <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 12, fontFamily: font }}>Objetivos nutricionales</div>
      <div style={{ ...baseCard, padding: 16, marginBottom: 8 }}>
        {[
          { label: "CalorÃ­as basales por defecto", val: nutSettings.basalCal, key: "basalCal" },
          { label: "Objetivo de proteÃ­nas (g)", val: nutSettings.protTarget, key: "protTarget" },
        ].map((f) => (
          <div key={f.key} style={{ marginBottom: 16 }}>
            <div style={{ fontSize: 12, color: C.textDim, marginBottom: 6 }}>{f.label}</div>
            <input type="number" value={f.val} onChange={(e) => setNutSettings((prev) => ({ ...prev, [f.key]: Number(e.target.value) || 0 }))}
              style={{ width: "100%", padding: "12px", borderRadius: 10, border: `1px solid ${C.border}`, background: C.bg, color: C.text, fontSize: 18, fontWeight: 700, outline: "none", fontFamily: font, boxSizing: "border-box", textAlign: "center" }} />
          </div>
        ))}
      </div>
      <p style={{ fontSize: 12, color: C.textDim, textAlign: "center", marginTop: 4, marginBottom: 28 }}>El basal se aplica como valor por defecto a dÃ­as nuevos. Puedes editarlo por dÃ­a.</p>

      {/* Coach IA (Gemini) */}
      <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 12, fontFamily: font }}>Coach IA (Gemini)</div>
      <div style={{ ...baseCard, padding: 16, marginBottom: 8 }}>
        <div style={{ fontSize: 12, color: C.textDim, marginBottom: 6 }}>API Key de Gemini</div>
        <input
          type="password"
          value={geminiKey}
          onChange={e => setGeminiKey(e.target.value.trim())}
          placeholder="Pega tu API Key aquÃ­..."
          style={{
            width: "100%", padding: "12px", borderRadius: 10,
            border: `1px solid ${geminiKey ? C.success + "40" : C.border}`,
            background: geminiKey ? C.successDim : C.bg,
            color: C.text, fontSize: 14, outline: "none", fontFamily: fontBody,
            boxSizing: "border-box",
          }}
        />
        {geminiKey && (
          <div style={{ fontSize: 12, color: C.success, marginTop: 8, fontWeight: 600 }}>âœ“ API Key configurada</div>
        )}
      </div>
      <p style={{ fontSize: 11, color: C.textDim, textAlign: "center", marginTop: 4, marginBottom: 16 }}>
        ObtÃ©n tu key gratis en <span style={{ color: C.accent }}>aistudio.google.com</span>
      </p>

      <div style={{ ...baseCard, padding: 16, marginBottom: 8 }}>
        <div style={{ fontSize: 12, color: C.textDim, marginBottom: 6 }}>Tu contexto personal</div>
        <textarea
          value={coachContext}
          onChange={e => setCoachContext(e.target.value)}
          placeholder="Describe tu perfil, objetivos, lesiones, preferencias... El Coach lo tendrÃ¡ siempre en cuenta."
          rows={4}
          style={{
            width: "100%", padding: "12px", borderRadius: 10,
            border: `1px solid ${C.border}`, background: C.bg, color: C.text,
            fontSize: 13, outline: "none", fontFamily: fontBody,
            resize: "vertical", lineHeight: 1.5, boxSizing: "border-box",
          }}
        />
        {coachContext && (
          <div style={{ fontSize: 11, color: C.success, marginTop: 6 }}>âœ“ {coachContext.length} caracteres</div>
        )}
      </div>

      <div style={{ ...baseCard, padding: 16, marginBottom: 8 }}>
        <div style={{ fontSize: 12, color: C.textDim, marginBottom: 10 }}>ExtensiÃ³n de las respuestas</div>
        <div style={{ display: "flex", gap: 6 }}>
          {[
            { id: "conciso", label: "Conciso" },
            { id: "normal", label: "Normal" },
            { id: "detallado", label: "Detallado" },
          ].map(opt => (
            <button key={opt.id} onClick={() => setCoachLength(opt.id)}
              style={{
                flex: 1, padding: "10px 8px", borderRadius: 10, border: "none",
                background: coachLength === opt.id ? C.accent : `rgba(255,255,255,0.06)`,
                color: coachLength === opt.id ? "#fff" : C.textDim,
                fontSize: 13, fontWeight: 600, cursor: "pointer",
              }}>
              {opt.label}
            </button>
          ))}
        </div>
      </div>
      <p style={{ fontSize: 11, color: C.textDim, textAlign: "center", marginTop: 4, marginBottom: 28 }}>
        El contexto y la extensiÃ³n se aplican a todas las conversaciones del Coach.
      </p>

      {/* Backup / Restaurar */}
      <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 12, fontFamily: font }}>Backup / Restaurar</div>
      <button onClick={backupAllData} style={{
        width: "100%", padding: "14px", borderRadius: 12, border: `1px solid ${C.accent}40`,
        background: C.accentDim, color: C.accent, fontSize: 14, fontWeight: 600, cursor: "pointer", marginBottom: 10,
      }}>Descargar backup completo</button>
      <label style={{
        display: "block", width: "100%", padding: "14px", borderRadius: 12, border: `1px solid ${C.border}`,
        background: C.card, color: C.textDim, fontSize: 14, fontWeight: 600, cursor: "pointer", textAlign: "center",
        boxSizing: "border-box",
      }}>
        Restaurar desde archivo
        <input type="file" accept=".json" onChange={(e) => { if (e.target.files[0]) restoreFromBackup(e.target.files[0]); e.target.value = ""; }}
          style={{ display: "none" }} />
      </label>
      <p style={{ fontSize: 11, color: C.textDim, textAlign: "center", marginTop: 8, marginBottom: 28 }}>
        El backup incluye entrenamientos, nutriciÃ³n, peso, ejercicios y alimentos personalizados.
      </p>

      {/* Datos de prueba */}
      {workouts.length === 0 && Object.keys(nutritionLog).length === 0 && (
        <>
          <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 12, fontFamily: font }}>Datos de prueba</div>
          <button onClick={() => {
            const nutLog = {};
            const wLog = [];
            const now = new Date();
            let w = 82;
            const meals = [
              [{ name: "Avena", cal: 280, prot: 7.5, grams: 75 }, { name: "YoPro", cal: 87, prot: 15, grams: 150 }, { name: "Pechuga pollo", cal: 214, prot: 47.4, grams: 200 }, { name: "Arroz", cal: 246, prot: 6, grams: 150 }, { name: "Ensalada variada", cal: 36, prot: 1.6, grams: 200 }],
              [{ name: "Clara de huevo", cal: 96, prot: 21.8, grams: 200 }, { name: "Pan Artesano", cal: 122, prot: 5, grams: 50 }, { name: "AtÃºn Natural", cal: 168, prot: 40.5, grams: 150 }, { name: "BrÃ³coli", cal: 53, prot: 3, grams: 150 }, { name: "FAGE 0%", cal: 81, prot: 15.5, grams: 150 }],
              [{ name: "Pechuga de pavo", cal: 224, prot: 50.2, grams: 200 }, { name: "Arroz integral", cal: 252, prot: 6, grams: 150 }, { name: "Queso Cottage ProteÃ­na", cal: 80, prot: 15, grams: 100 }, { name: "PlÃ¡tano", cal: 92, prot: 1.1, grams: 100 }, { name: "Anacardos/Nueces", cal: 180, prot: 5.4, grams: 30 }],
              [{ name: "SalmÃ³n Ahumado", cal: 226, prot: 24, grams: 100 }, { name: "RequesÃ³n", cal: 108, prot: 18.3, grams: 150 }, { name: "Filete ternera", cal: 250, prot: 43, grams: 200 }, { name: "Edamame", cal: 124, prot: 11, grams: 100 }, { name: "Chocolate 70%", cal: 96, prot: 2.2, grams: 20 }],
              [{ name: "Protein+", cal: 69, prot: 12, grams: 150 }, { name: "All Bran", cal: 168, prot: 7, grams: 50 }, { name: "AlbÃ³ndigas", cal: 300, prot: 24, grams: 200 }, { name: "Gazpacho", cal: 90, prot: 1.6, grams: 200 }, { name: "Pavo Cocido (Merc)", cal: 78, prot: 17.8, grams: 100 }],
            ];
            for (let i = 60; i >= 0; i--) {
              const d = new Date(now); d.setDate(d.getDate() - i);
              const key = d.toISOString().slice(0, 10);
              const dayMeals = meals[Math.floor(Math.random() * meals.length)];
              const skip = Math.random() < 0.1;
              if (!skip) {
                const activity = Math.random() < 0.5 ? Math.round(200 + Math.random() * 400) : 0;
                nutLog[key] = {
                  meals: dayMeals.map((m) => ({ ...m, id: Date.now() + Math.random() * 1e6, fromDB: true })),
                  basalCal: 2100, activityCal: activity,
                };
              }
              if (i % 3 === 0) {
                w += (Math.random() - 0.55) * 0.4;
                wLog.push({ date: key, weight: Math.round(w * 10) / 10 });
              }
            }
            setNutritionLog(nutLog);
            setWeightLog(wLog);
            const wkTemplates = [
              [{ id: "bench_press", sets: [{w:80,r:10},{w:85,r:8},{w:85,r:8}] }, { id: "incline_db_press", sets: [{w:30,r:10},{w:32,r:8},{w:32,r:8}] }, { id: "chest_fly", sets: [{w:15,r:12},{w:15,r:12}] }, { id: "tricep_pushdown", sets: [{w:30,r:12},{w:35,r:10},{w:35,r:10}] }],
              [{ id: "lat_pulldown", sets: [{w:60,r:10},{w:65,r:8},{w:65,r:8}] }, { id: "barbell_row", sets: [{w:60,r:10},{w:65,r:8},{w:65,r:8}] }, { id: "seated_cable_row", sets: [{w:50,r:12},{w:55,r:10}] }, { id: "barbell_curl", sets: [{w:25,r:10},{w:25,r:10},{w:25,r:8}] }],
              [{ id: "squat", sets: [{w:90,r:8},{w:95,r:6},{w:95,r:6}] }, { id: "leg_press", sets: [{w:150,r:10},{w:160,r:8},{w:160,r:8}] }, { id: "leg_curl", sets: [{w:40,r:12},{w:45,r:10}] }, { id: "calf_raise", sets: [{w:60,r:15},{w:60,r:15}] }],
              [{ id: "ohp", sets: [{w:40,r:10},{w:45,r:8},{w:45,r:8}] }, { id: "lateral_raise", sets: [{w:12,r:12},{w:12,r:12},{w:14,r:10}] }, { id: "face_pull", sets: [{w:20,r:15},{w:20,r:15}] }, { id: "pushup", sets: [{r:20},{r:18},{r:15}] }],
            ];
            const wks = [];
            for (let i = 55; i >= 0; i -= Math.floor(2 + Math.random() * 2)) {
              const d = new Date(now); d.setDate(d.getDate() - i);
              const tmpl = wkTemplates[Math.floor(Math.random() * wkTemplates.length)];
              wks.push({
                id: Date.now() + i,
                date: d.toISOString(),
                exercises: tmpl.map((ex) => ({
                  exerciseId: ex.id,
                  sets: ex.sets.map((s) => s.w ? { weight: String(s.w), reps: String(s.r), done: true } : { reps: String(s.r), done: true }),
                })),
              });
            }
            setWorkouts(wks);
          }} style={{
            width: "100%", padding: "14px", borderRadius: 12, border: `1px solid ${C.danger}40`,
            background: `${C.danger}15`, color: C.danger, fontSize: 13, fontWeight: 600, cursor: "pointer",
          }}>ğŸ§ª Cargar datos de prueba (60 dÃ­as)</button>
        </>
      )}
    </div>
  );

  // â•â•â• TAB BAR & LAYOUT â•â•â•
  const tabs = [
    { id: "home", icon: "ğŸ‹ï¸", label: "Entreno" },
    { id: "nutrition", icon: "ğŸ½ï¸", label: "NutriciÃ³n" },
    { id: "coach", icon: "ğŸ¤–", label: "Coach" },
    { id: "config", icon: "âš™ï¸", label: "Ajustes" },
  ];

  if (!loaded) return (
    <div style={{ background: C.bg, minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center" }}>
      <div style={{ color: C.accent, fontSize: 32 }}>ğŸ‹ï¸</div>
    </div>
  );

  const showTabBar = !["workout", "picker", "circuit-setup", "plan-edit"].includes(view) && !editingWorkout;

  return (
    <div style={{ background: C.bg, minHeight: "100vh", maxWidth: 480, margin: "0 auto", fontFamily: fontBody, color: C.text, position: "relative" }}>
      {view === "home" && renderHome()}
      {view === "workout" && renderActiveWorkout()}
      {view === "picker" && renderExercisePicker()}
      {view === "history" && renderHistory()}
      {view === "nutrition" && renderNutrition()}
      {view === "detail" && renderDetail()}
      {view === "progress" && renderProgress()}
      {view === "exercises" && renderExercises()}
      {view === "circuit-setup" && renderCircuitSetup()}
      {view === "plans" && renderPlans()}
      {view === "plan-edit" && renderPlanEdit()}
      {view === "coach" && renderCoach()}
      {view === "config" && renderConfig()}
      {exportData && (
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.85)", zIndex: 1000,
          display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center",
          padding: 20,
        }}>
          <div style={{ width: "100%", maxWidth: 440 }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
              <span style={{ fontSize: 16, fontWeight: 700, color: C.text, fontFamily: font }}>{exportType}</span>
              <button onClick={() => setExportData(null)} style={{ background: "none", border: "none", color: C.textDim, fontSize: 24, cursor: "pointer" }}>âœ•</button>
            </div>
            <textarea id="export-textarea" readOnly value={exportData}
              onFocus={(e) => { e.target.select(); e.target.setSelectionRange(0, 99999); }}
              style={{ width: "100%", height: 300, padding: 14, borderRadius: 12, border: `1px solid ${C.border}`, background: C.card, color: C.text, fontSize: 12, fontFamily: "monospace", resize: "none", boxSizing: "border-box", outline: "none" }} />
            <button onClick={selectAllExport} style={{ width: "100%", padding: "14px", borderRadius: 12, border: "none", background: C.accent, color: "#fff", fontSize: 14, fontWeight: 700, cursor: "pointer", marginTop: 10 }}>Seleccionar todo</button>
            <p style={{ fontSize: 12, color: C.textDim, textAlign: "center", marginTop: 8 }}>Selecciona â†’ Copia â†’ Pega donde quieras</p>
          </div>
        </div>
      )}
      {showTabBar && (
        <div style={{
          position: "fixed", bottom: 0, left: "50%", transform: "translateX(-50%)",
          width: "100%", maxWidth: 480, display: "flex", justifyContent: "space-around",
          padding: "12px 0 28px", background: `linear-gradient(to top, ${C.bg} 60%, transparent)`,
          backdropFilter: "blur(20px)", borderTop: `1px solid ${C.border}`,
        }}>
          {tabs.map((tab) => (
            <button key={tab.id} onClick={() => { setEditingWorkout(null); if (tab.id === "nutrition") setNutView("summary"); setView(tab.id); }} style={{
              background: "none", border: "none", fontSize: 11, cursor: "pointer",
              color: [tab.id, ...(tab.id === "home" ? ["history", "exercises", "detail", "progress", "plans"] : [])].includes(view) ? C.accent : C.textDim,
              display: "flex", flexDirection: "column", alignItems: "center", gap: 4, padding: "4px 16px",
            }}>
              <span style={{ fontSize: 22 }}>{tab.icon}</span>
              <span style={{ fontWeight: 600 }}>{tab.label}</span>
            </button>
          ))}
        </div>
      )}
    </div>
  );
}


// Mount the app
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<WorkoutTracker />);
  </script>
</body>
</html>